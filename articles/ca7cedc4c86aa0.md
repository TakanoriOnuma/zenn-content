---
title: "„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™API„É™„ÇØ„Ç®„Çπ„Éà„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰Ωú„Çã"
emoji: "üòΩ"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["promise", "api"]
published: true
published_at: 2019-01-07
---

:::message
„Åì„Çå„ÅØ2019Âπ¥01Êúà07Êó•„Å´Qiita„Åß‰ΩúÊàê„Åó„ÅüË®ò‰∫ã„ÇíÁßªË°å„Åó„Åü„ÇÇ„ÅÆ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
:::

# Âßã„ÇÅ„Å´

ÁöÜ„Åï„Çì„ÅØÈÄö‰ø°‰∏≠„Å´„Ç≠„É£„É≥„Çª„É´„Åô„ÇãÊ©üËÉΩ„ÇíÁî®ÊÑè„Åó„Å¶„ÅÑ„Åæ„Åô„Åß„Åó„Çá„ÅÜ„Åã„ÄÇÈÄö‰ø°„ÅÆ„Ç≠„É£„É≥„Çª„É´„ÅØÊôÆÊÆµÂøÖË¶Å„Å™„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„Åå„ÄÅ„ÅÇ„ÇãÁä∂Ê≥Å‰∏ã„ÅßÂõ∞„Å£„Å¶„Åó„Åæ„ÅÜ„Ç±„Éº„Çπ„ÅåËµ∑„Åç„Å¶„Åó„Åæ„ÅÜ„ÅÆ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Åã„Å™„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ

- „É¨„Çπ„Éù„É≥„Çπ„ÅåÂª∂„ÄÖ„Å®Ëøî„Å£„Å¶„Åì„Å™„ÅÑÊôÇ„Åå„ÅÇ„Å£„Å¶ÈÄö‰ø°Â∏ØÂüü„ÇíÈÄºËø´„Åï„Åõ„Çã
- ÈÄö‰ø°‰∏≠„Å´„Éñ„É©„Ç¶„Ç∂„Éê„ÉÉ„ÇØ„Åï„Çå„Åü„Åü„ÇÅÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åü„ÅÑ

„É¨„Çπ„Éù„É≥„ÇπËøî„Å£„Å¶„Åì„Å™„ÅÑÂïèÈ°å„ÅØtimeout„ÇíË®≠ÂÆö„Åó„Å¶„Åä„Åë„Å∞ÂïèÈ°å„Å™„ÅÑ„Åß„Åô„Åå„ÄÅÈÄö‰ø°‰∏≠„ÅÆ„Éñ„É©„Ç¶„Ç∂„Éê„ÉÉ„ÇØ„ÅØ„Ç≠„É£„É≥„Çª„É´„Åó„Å¶„Åä„Åã„Å™„ÅÑ„Å®Âé≥„Åó„ÅÑ„Åã„Å™„Å®ÊÄù„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ

„Åü„Å†„Ç≠„É£„É≥„Çª„É´„ÇíÂÆüË£Ö„Åó„Çà„ÅÜ„Å®„Åô„Çã„Å®Â§âÊï∞„ÅåÂ¢ó„Åà„Åü„ÇäÁµêÊßã„ÇÑ„ÇÑ„Åì„Åó„Åè„Å™„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„ÅôÔºàaxios„ÇÇ„Ç≠„É£„É≥„Çª„É´„Éà„Éº„ÇØ„É≥„Çí„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ„Å®„ÅÑ„Åë„Å™„ÅÑ„Åß„Åô„ÅóÔºâ„ÄÇÂÄã‰∫∫ÁöÑ„Å´„ÅØPromise„Å´cancel„É°„ÇΩ„ÉÉ„Éâ„Åå„Å§„ÅÑ„Å¶„ÅÑ„Åü„Çâ„Å™„ÅÅ„Å®ÊÄù„Å£„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„Éá„Éï„Ç©„É´„Éà„Åß„ÅØ„Çµ„Éù„Éº„Éà„Åó„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô„ÄÇ

https://blog.jxck.io/entries/2017-07-19/aborting-fetch.html

„Åó„Åã„ÅócancelÂèØËÉΩ„Å™Promise„Åånpm„Éë„ÉÉ„Ç±„Éº„Ç∏„Å®„Åó„Å¶‰Ωú„Çâ„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åì„Çå„Çí‰Ωø„Å£„Å¶cancel„Åó„Åü„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ

https://github.com/sindresorhus/p-cancelable

„Åõ„Å£„Åã„Åè„Å™„ÅÆ„Åß„ÇØ„É©„Çπ„Çí‰Ωú„Å£„Å¶„ÄÅÈÄö‰ø°‰∏≠„ÅÆ„ÇÇ„ÅÆ„ÇíÂÖ®„Å¶ÂâäÈô§„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åó„Å¶„ÄÅ„Åù„Çå„Çí„Éë„ÉÉ„Ç±„Éº„Ç∏Âåñ„Å´„Åô„Çã„Å®„Åì„Çç„Åæ„ÅßÂÆüË£Ö„Åó„Åæ„Åó„Åü„ÄÇ

# p-cancelable„ÇíËøî„Åó„Å¶ÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åï„Åõ„Çã

axios„Çí„É©„ÉÉ„Éó„Åó„Å¶„ÄÅpromise„Åß„ÅØ„Å™„Åè„ÄÅpCancelable„ÇíËøî„Åó„Åæ„Åô„ÄÇpCancelable„ÅØpromise„ÇíÁ∂ôÊâø„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅÂü∫Êú¨ÁöÑ„Å´„ÅØPromise„Å®Âêå„Åò„Åß„Åô„ÄÇ„Åì„Çå„Å´„Ç≠„É£„É≥„Çª„É´„É°„ÇΩ„ÉÉ„Éâ„Åå„Å§„ÅÑ„Åü„Å†„Åë„Åß„Åô„ÄÇ
„Éë„É©„É°„Éº„Çø„Åå„Åã„Å™„ÇäÂ§ö„Åè„Å™„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü„Åå„ÄÅÊ±éÁî®ÊÄß„ÅÆ„Åü„ÇÅ‰ªïÊñπ„Å™„ÅÑ„Åß„Åô„ÄÇcallbacks„ÅØ„Éï„ÉÉ„ÇØ„Åô„Çã„Åü„ÇÅ„Å´Áî®ÊÑè„Åó„Å¶„ÅÑ„Çã„Å†„Åë„Å™„ÅÆ„Åß„ÄÅ‰∏çË¶Å„Åß„ÅÇ„Çå„Å∞‰Ωø„Çè„Å™„Åè„Å¶Â§ß‰∏àÂ§´„Åß„Åô„ÄÇ

```js:request.js
import axios from 'axios';
import urlJoin from 'url-join';
import PCancelable from 'p-cancelable';

// API„É°„ÇΩ„ÉÉ„Éâ
export const GET = 'get';
export const POST = 'post';
export const PUT = 'put';
export const DELETE = 'delete';

/**
 * APIÈÄö‰ø°„Çí„Åô„Çã
 * @param {string} apiRoot - API„É´„Éº„Éà
 * @param {Object} options - API„Ç™„Éó„Ç∑„Éß„É≥
 * @param {string} options.method - ÈÄö‰ø°„É°„ÇΩ„ÉÉ„ÉâÂêç
 * @param {string} options.endpoint - ÈÄö‰ø°ÂÖà
 * @param {Object?} options.query - ÈÄö‰ø°„Å´„Å§„Åë„Çã„ÇØ„Ç®„É™
 * @param {Object?} options.header - ÈÄö‰ø°„Å´„Å§„Åë„Çã„Éò„ÉÉ„ÉÄ„Éº
 * @param {number?} options.timeout - ÈÄö‰ø°„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
 * @param {Object} callbacks - „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞Áæ§
 * @param {function?} callbacks.onRequestStart - „É™„ÇØ„Ç®„Çπ„ÉàÈñãÂßãÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
 * @param {function?} callbacks.onSuccess - ÊàêÂäüÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
 * @param {function?} callbacks.onFailure - Â§±ÊïóÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
 * @param {function?} callbacks.onCancel - „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
 * @param {function?} callbacks.onRequestEnd - „É™„ÇØ„Ç®„Çπ„ÉàÁµÇ‰∫ÜÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
 * @returns {PCancelable} - „Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™Promise
 */
export function request(apiRoot, options, callbacks = {}) {
  const {
    method,
    endpoint,
    query = {},
    timeout = 15000
  } = options;
  const headers = {
    ...options.headers
  };

  const url = urlJoin(apiRoot, endpoint);

  // axios„Åß„Ç≠„É£„É≥„Çª„É´„Åô„Çã„Åü„ÇÅ„Å´source„Çí‰Ωú„Çã
  const source = axios.CancelToken.source();

  return new PCancelable((resolve, reject, onCancel) => {
    // „É™„ÇØ„Ç®„Çπ„ÉàÈñãÂßã„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂëº„Å∂
    callbacks.onRequestStart && callbacks.onRequestStart({ method, url });

    // request„ÅÆ„Éë„É©„É°„Éº„Çø„ÇíÁîüÊàê„Åô„Çã
    const requestOptions = {
      method,
      url,
      headers,
      timeout,
      cancelToken: source.token
    };
    requestOptions[method === GET ? 'params' : 'data'] = query;

    // „É™„ÇØ„Ç®„Çπ„Éà„ÅÆÁîüÊàê
    axios(requestOptions)
      .then((res) => {
        // „É™„ÇØ„Ç®„Çπ„ÉàÊàêÂäü„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂëº„Å∂
        callbacks.onSuccess && callbacks.onSuccess({ method, url }, res);
        resolve(res);
      })
      .catch((err) => {
        // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„ÅüÊôÇ„ÅÆ„Ç®„É©„Éº„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàonCancelÂÅ¥„ÅßÂá¶ÁêÜ„ÇíÊõ∏„Åè)
        if (axios.isCancel(err)) {
          return;
        }
        // „É™„ÇØ„Ç®„Çπ„ÉàÂ§±Êïó„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂëº„Å∂
        callbacks.onFailure && callbacks.onFailure({ method, url }, err);
        reject({
          isCancel: false,
          err
        });
      })
      .finally(() => {
        // „É™„ÇØ„Ç®„Çπ„ÉàÁµÇ‰∫Ü„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂëº„Å∂
        callbacks.onRequestEnd && callbacks.onRequestEnd({ method, url });
      });

    // „Ç≠„É£„É≥„Çª„É´„ÇíÂÆüË°å„Åó„ÅüÊôÇ
    onCancel(() => {
      // „Ç≠„É£„É≥„Çª„É´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂëº„Å∂
      callbacks.onCancel && callbacks.onCancel({ method, url });
      // ÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åô„Çã
      source.cancel();
      reject({
        isCancel: true
      });
    });
  });
}
```

„Åì„Çå„Åß‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„Åó„Åü„ÇâÈÄö‰ø°‰∏≠„Å´„Ç≠„É£„É≥„Çª„É´„Åå„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇÁ∞°Âçò„Åß„Åô„Å≠ÔºÅ

```js:request„ÅÆ„Çµ„É≥„Éó„É´„Ç≥„Éº„Éâ
import { request, GET } from './request.js';

const pCancelable = request('http://localhost:8080', {
  method: GET,
  endpoint: '/data'
});

pCancelable
  .then((response) => {
    console.log(response);
  })
  .catch(({ isCancel, err }) => {
    // „Ç≠„É£„É≥„Çª„É´„Åó„Åü„Åã„ÅÆ„Éï„É©„Ç∞„ÉÅ„Çß„ÉÉ„ÇØ
    if (isCancel) {
      console.log('canceled.');
      return;
    }
    console.error(err);
  });

// 1ÁßíÂæå„Å´„Ç≠„É£„É≥„Çª„É´„Åô„Çã
window.setTimeout(() => {
  pCancelable.cancel();
}, 1000);
```

„Åü„Å†1ÂÄã„Å†„ÅëÊ≥®ÊÑè„Åó„Å™„Åë„Çå„Å∞„ÅÑ„Åë„Å™„ÅÑ„ÅÆ„Åå„ÄÅrequest„ÇíÂÆüË°å„Åó„Åü„Çâ‰∏ÄÂõûpromise„ÇíÂèó„ÅëÂèñ„Çâ„Å™„ÅÑ„Å®„ÅÑ„Åë„Å™„ÅÑ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´`.then().catch()`„ÅßÁπã„Åí„Åü„ÇÇ„ÅÆ„ÇíÂèó„ÅëÂèñ„Å£„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì„ÄÇÊÑèÂ§ñ„Å®Ê∞ó„Å•„Åã„Å™„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„Åå„ÄÅÂÆü„ÅØ`.then()`„ÇÑ`.catch()`„ÇíÂÆüË°å„Åô„Çã„Åü„Å≥„Å´Êñ∞„Åó„ÅÑPromise„Åå‰Ωú„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊñ∞„Åó„Åè‰Ωú„Çâ„Çå„ÅüPromise„ÅØcancelÂèØËÉΩ„Å™Promise„Åß„ÅØ„Å™„Åè„ÄÅ„Åü„Å†„ÅÆPromise„Å™„ÅÆ„Åßcancel„É°„ÇΩ„ÉÉ„Éâ„Åå‰Ωø„Åà„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇ

```js:Â§±Êïó‰æã
// pCancelable„Åß„ÅØ„Å™„ÅèÊôÆÈÄö„ÅÆpromise„ÇíÂèó„ÅëÂèñ„Å£„Å¶„ÅÑ„Çã
const pCancelable = request('http://localhost:8080', {
  method: GET,
  endpoint: '/data'
})
  .then((response) => {
    console.log(response);
  })
  .catch(({ isCancel, err }) => {
    // „Ç≠„É£„É≥„Çª„É´„Åó„Åü„Åã„ÅÆ„Éï„É©„Ç∞„ÉÅ„Çß„ÉÉ„ÇØ
    if (isCancel) {
      console.log('canceled.');
      return;
    }
    console.error(err);
  });

// cancel„É°„ÇΩ„ÉÉ„Éâ„Åå„Å™„ÅÑ„Å®ÊÄí„Çâ„Çå„Çã
pCancelable.cancel();
```

„Åì„Çå„Åß„Ç≠„É£„É≥„Çª„É´„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ„Åü„Å†„Ç≠„É£„É≥„Çª„É´„Çí„Åô„Çã„Åü„ÇÅ„Å´ÂÖ®„Å¶„ÅÆpCancelable„ÇíÁÆ°ÁêÜ„Åô„Çã„ÅÆ„ÅØÂ§ßÂ§â„ÅÆ„Å™„ÅÆ„Åß„ÄÅ„Åù„Çå„ÇíÁÆ°ÁêÜ„Åô„Çã„ÇØ„É©„Çπ„ÇíÁî®ÊÑè„Åó„Åæ„Åô„ÄÇ

# CancelableAPI„ÇØ„É©„Çπ„Çí‰Ωú„Çã

ÂÖà„Åª„Å©‰Ωú„Å£„Åürequest„É¢„Ç∏„É•„Éº„É´„Çí‰Ωø„Å£„Å¶„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™API„ÇØ„É©„Çπ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆ„ÇØ„É©„Çπ„ÅßpCancelable„É™„Çπ„Éà„Çí‰øùÊåÅ„Åó„Å¶„ÄÅ`cancelAll`„ÇíÂÆüË°å„Åó„ÅüÊôÇ„Å´ÈÄö‰ø°‰∏≠„ÅÆpCancelable„ÇíÂÖ®„Å¶„Ç≠„É£„É≥„Çª„É´„Åô„Çã„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ

```js:CancelableAPI.js
import { request, GET, POST, PUT, DELETE } from './request';

// API„Ç§„É≥„Çπ„Çø„É≥„Çπ„É™„Çπ„Éà
const APIs = [];

/**
 * APIÈÄö‰ø°„ÅÆ„Éô„Éº„Çπ„Å®„Å™„Çã„ÇØ„É©„Çπ
 */
class CancelableAPI {
  // HTTP„É°„ÇΩ„ÉÉ„Éâ
  static GET = GET;
  static POST = POST;
  static PUT = PUT;
  static DELETE = DELETE;

  /**
   * „Ç≥„É≥„Çπ„Éà„É©„ÇØ„Çø
   * @param {string} apiRoot - API„É´„Éº„Éà
   */
  constructor(apiRoot = '') {
    // API„É´„Éº„Éà
    this.apiRoot = apiRoot;
    // ÈÄö‰ø°‰∏≠„ÅÆcancelable promise„É™„Çπ„Éà
    this.pCancelableList = [];
    // API„Ç§„É≥„Çπ„Çø„É≥„Çπ„É™„Çπ„Éà„Å´ÁôªÈå≤„Åô„Çã
    APIs.push(this);
  }

  /**
   * API„É´„Éº„Éà„ÅÆË®≠ÂÆö
   * @param {string} apiRoot - API„É´„Éº„Éà
   */
  setAPIRoot(apiRoot) {
    this.apiRoot = apiRoot;
  }

  /**
   * APIÈÄö‰ø°„Çí„Åô„Çã
   * @param {Object} requestOptions - „É™„ÇØ„Ç®„Çπ„Éà„Ç™„Éó„Ç∑„Éß„É≥
   * @param {string} requestOptions.method - ÈÄö‰ø°„É°„ÇΩ„ÉÉ„ÉâÂêç
   * @param {string} requestOptions.endpoint - ÈÄö‰ø°ÂÖà
   * @param {Object?} requestOptions.query - ÈÄö‰ø°„Å´„Å§„Åë„Çã„ÇØ„Ç®„É™
   * @param {Object?} requestOptions.header - ÈÄö‰ø°„Å´„Å§„Åë„Çã„Éò„ÉÉ„ÉÄ„Éº
   * @param {number?} requestOptions.timeout - ÈÄö‰ø°„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
   * @param {Object} callbacks - „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞Áæ§
   * @param {function?} callbacks.onRequestStart - „É™„ÇØ„Ç®„Çπ„ÉàÈñãÂßãÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
   * @param {function?} callbacks.onSuccess - ÊàêÂäüÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
   * @param {function?} callbacks.onFailure - Â§±ÊïóÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
   * @param {function?} callbacks.onCancel - „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
   * @param {function?} callbacks.onRequestEnd - „É™„ÇØ„Ç®„Çπ„ÉàÁµÇ‰∫ÜÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
   * @returns {PCancelable} - „Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™Promise
   */
  request(requestOptions, callbacks = {}) {
    // pCancelable„É™„Çπ„Éà„Å´ÁôªÈå≤„Åô„Çã
    const pCancelable = request(this.apiRoot, requestOptions, callbacks);
    this.pCancelableList.push(pCancelable);

    pCancelable
      // catch„Åó„Å™„ÅÑ„Å®„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂá∫„Å¶„Åè„Çã„ÅÆ„ÅßÂèó„ÅëÂèñ„Å£„Å¶„Åä„Åè
      .catch(() => {})
      // Promise„ÅåÁµÇ‰∫Ü„Åó„ÅüÊôÇ„Å´„É™„Çπ„Éà„Åã„ÇâÂ§ñ„Åô
      .finally(() => {
        this.pCancelableList = this.pCancelableList.filter((promise) => promise !== pCancelable);
      });

    return pCancelable;
  }

  /**
   * ‰∏Ä„Å§„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅßÂÆüË°å„Åï„Çå„ÅüÈÄö‰ø°‰∏≠„ÅÆ„ÇÇ„ÅÆ„ÇíÂÖ®„Å¶„Ç≠„É£„É≥„Çª„É´„Åô„Çã
   */
  cancelAll() {
    this.pCancelableList.forEach((pCancelable) => {
      pCancelable.cancel();
    });

    // cancelable„ÅÆ„É™„Çπ„Éà„ÅØrequest„É°„ÇΩ„ÉÉ„ÉâÂÅ¥„ÅßÂ§ñ„Çå„Çã„Åå„ÄÅÂÖà„Å´Â§ñ„Åó„Å¶„Åó„Åæ„ÅÜ
    this.pCancelableList = [];
  }

  /**
   * ÈùôÁöÑ„Ç≠„É£„É≥„Çª„É´„É°„ÇΩ„ÉÉ„Éâ„Åß„ÄÅÂÖ®„Å¶„ÅÆÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åô„Çã
   */
  static cancelAll() {
    APIs.forEach((API) => {
      API.cancelAll();
    });
  }
}

export default CancelableAPI;
```

„Åì„ÅÆ„ÇØ„É©„Çπ„ÇíÁ∂ôÊâø„Åó„Å¶„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åî„Å®„Å´Êã°Âºµ„Åô„Çã„Åì„Å®„ÅßÂÆπÊòì„Å´„Ç≠„É£„É≥„Çª„É´„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ

```js:CancelableAPI„Çí‰Ωø„Å£„Åü‰æã
import CancelableAPI from 'CancelableAPI.js';

class BaseAPI extends CancelableAPI {
  /**
   * „É™„ÇØ„Ç®„Çπ„Éà„ÅÆ„ÉÜ„Çπ„Éà
   * @returns {PCancelable}
   */
  fetch() {
    return this.request({
      method: CancelableAPI.GET,
      endpoint: '/data'
    });
  }
}

// API„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰Ωú„Çã
const API = new BaseAPI('http://localhost:8080');

// „É™„ÇØ„Ç®„Çπ„Éà„Çí10ÂõûÈÄÅ„Çã
for (let i = 0; i < 10; i++) {
  API.fetch()
    .then((response) => {
      console.log(response);
    })
    .catch(({ isCancel, err }) => {
      if (err) {
        console.error(err);
      }
    });
}

// 1ÁßíÂæå„Å´„Åæ„Å®„ÇÅ„Å¶„Ç≠„É£„É≥„Çª„É´„Åô„Çã
window.setTimeout(() => {
  API.cancelAll();
}, 1000);
```

Ë§áÊï∞„ÅÆAPI„ÅßÈÄö‰ø°„Åó„Å¶„ÅÑ„Å¶„ÄÅÂÖ®„Å¶„ÅÆAPI„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ`CancelableAPI.cancelAll()`„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ

```js:Ë§áÊï∞„ÅÆAPI„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí„Åæ„Å®„ÇÅ„Å¶„Ç≠„É£„É≥„Çª„É´„Åô„Çã
// API„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰Ωú„Çã
const API1 = new BaseAPI('http://localhost:8080');
const API2 = new BaseAPI('http://localhost:10000');

API1.fetch();
API2.fetch();

// API1, API2„Åù„Çå„Åû„Çå„ÅßÈÄö‰ø°‰∏≠„ÅÆ„ÇÇ„ÅÆ„Çí„Åæ„Å®„ÇÅ„Å¶„Ç≠„É£„É≥„Çª„É´„Åô„Çã
CancelabelAPI.cancelAll();
```

pCancelable„ÇíËøî„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅßÂΩìÁÑ∂ÂÄãÂà•„Åß„Ç≠„É£„É≥„Çª„É´„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ

```js:ÂÄãÂà•„Åß„Ç≠„É£„É≥„Çª„É´„Åô„Çã
const pCancelable = API.fetch();

pCancelabel.cancel();
```

# „Ç§„Éô„É≥„Éà„Çí„Éï„ÉÉ„ÇØ„Åô„Çã

ÂÉï„ÅØ„Çà„ÅèÈÄö‰ø°ÈñãÂßã„ÇÑÈÄö‰ø°ÁµÇ‰∫Ü„Çístore„Å´‰øùÂ≠ò„Åó„Å¶„ÄÅÈÄö‰ø°‰∏≠„ÅØ‰∏ä„Å´ÈÄèÊòé„Å™„É¨„Ç§„É§„Éº„ÇíÁΩÆ„ÅÑ„Å¶„Çø„ÉÉ„ÉÅÊìç‰Ωú„ÇíÂá∫Êù•„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åù„ÅÜ„Åó„Åü„Éï„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÊõ∏„Åë„Çã„Çà„ÅÜ„Å´callback„ÇíÊèê‰æõ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„ÅÆË®ò‰∫ã„ÅÆÊúÄÂæå„Å´„Çµ„É≥„Éó„É´„É™„Éù„Ç∏„Éà„É™„ÇíÁΩÆ„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÅÆ„Åß„ÄÅË©≥Á¥∞„ÅØ„Åù„Å°„Çâ„ÅÆÊñπ„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

```js:„Ç§„Éô„É≥„Éà„Çí„Éï„ÉÉ„ÇØ„Åó„Å¶store„Å´commit„Åô„Çã
// CancelableAPI„Çí‰ΩøÁî®„Åô„Çã
import CancelableAPI from 'cancelable-api';

// store„Å´commit„Åô„Çã
import store from './store/';
import * as mutationTypes from './store/api/mutationTypes';

class API extends CancelableAPI {
  /**
   * APIÈÄö‰ø°„Çí„Åô„Çã
   * @param {Object} requestOptions - „É™„ÇØ„Ç®„Çπ„Éà„Ç™„Éó„Ç∑„Éß„É≥
   * @param {string} requestOptions.method - ÈÄö‰ø°„É°„ÇΩ„ÉÉ„ÉâÂêç
   * @param {string} requestOptions.endpoint - ÈÄö‰ø°ÂÖà
   * @param {Object?} requestOptions.query - ÈÄö‰ø°„Å´„Å§„Åë„Çã„ÇØ„Ç®„É™
   * @param {Object?} requestOptions.header - ÈÄö‰ø°„Å´„Å§„Åë„Çã„Éò„ÉÉ„ÉÄ„Éº
   * @param {number?} requestOptions.timeout - ÈÄö‰ø°„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
   * @returns {PCancelable} - „Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™Promise
   */
  request(requestOptions) {
    return super.request(requestOptions, {
      // ÂêÑ„Ç§„Éô„É≥„Éà„Çí„Éï„ÉÉ„ÇØ„Åô„Çã
      onRequestStart: ({ method, url }) => { store.commit(mutationTypes.REQUESTING, { method, url }); },
      onSuccess: ({ method, url }) => { store.commit(mutationTypes.SUCCESS, { method, url }); },
      onFailure: ({ method, url }) => { store.commit(mutationTypes.FAILURE, { method, url }); },
      onCancel: ({ method, url }) => { store.commit(mutationTypes.CANCEL, { method, url }); },
      // onRequestEnd: () => { console.log('request end'); }
    });
  }

  /**
   * „É™„ÇØ„Ç®„Çπ„Éà„ÅÆ„ÉÜ„Çπ„Éà
   * @returns {PCancelable}
   */
  fetch() {
    return this.request({
      method: CancelableAPI.GET,
      endpoint: '/exec'
    });
  }
}

export default API;
```

## „Å°„Å™„Åø„Å´

API„Åã„Çâstore„Å´commit„Åô„ÇãÊñπÊ≥ï„ÇíÊõ∏„ÅÑ„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅÈÄÜ„Å´store„Å∏„ÅÆaction„ÇíÈÄö„Åò„Å¶API„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ„ÇãÂ†¥Âêà„ÅØactionÂÜÖ„ÅßÂÆüË°å„Åô„Çå„Å∞„ÅÑ„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ„Åü„Å†action„Åã„ÇâËøî„Åó„Åü„ÇÇ„ÅÆ„ÅØ‰∏ÄÂ∫¶Promise„Åß„É©„ÉÉ„Éó„Åï„Çå„ÅüÊ∞ó„Åå„Åó„Å¶„ÄÅcancel„É°„ÇΩ„ÉÉ„Éâ„ÅåÊ∂à„Åà„Å¶„Åó„Åæ„Å£„ÅüÊ∞ó„Åå„Åó„Åæ„Åô„Éª„Éª„Éª„ÄÇ
„Åü„Å†ÂÖ®„Å¶„ÅÆÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åô„Çã„Å†„Åë„Å™„Çâ„Åì„Çå„Åß„ÇÇ„ÅÑ„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ

```js:action„ÅßÈÄö‰ø°„ÇíÊõ∏„ÅèÂ†¥Âêà
export default {
  actions: {
    fetch({ state, commit }) {
      const pCancelable = API.fetch();
      pCancelable
        .then((response) => {
          commit('save', response);
        });
      // „Åì„ÅÜ„ÇÑ„Å£„Å¶„ÇÇÁµêÂ±Äpromise„Åß„É©„ÉÉ„Éó„Åï„Çå„Å¶„Åó„Åæ„Å£„ÅüÊ∞ó„Åå„Åô„Çã
      return pCancelable;
    },
    // ÂÖ®„Å¶„ÅÆÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åô„Çã„Åì„Å®„ÅØÂá∫Êù•„Çã
    cancelAll() {
      API.cancelAll();
    }
  }
}
```

# „Éë„ÉÉ„Ç±„Éº„Ç∏Âåñ„Åô„Çã

ÊäòËßí„Å™„ÅÆ„Åß„Åì„ÅÆCancelabelAPI„Çí„Éë„ÉÉ„Ç±„Éº„Ç∏Âåñ„Åó„Åæ„Åó„Åü„ÄÇ‰ª•‰∏ã„Åß„Ç§„É≥„Çπ„Éà„Éº„É´„Åß„Åç„Åæ„Åô„ÄÇ

```
$ yarn add TakanoriOnuma/cancelable-api
```

„É™„Éù„Ç∏„Éà„É™„ÅØ„Åì„Å°„Çâ„Å´ÁΩÆ„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ
https://github.com/TakanoriOnuma/cancelable-api

„Éë„ÉÉ„Ç±„Éº„Ç∏Âåñ„ÅÆÊñπÊ≥ï„ÅØ‰ª•‰∏ã„ÇíÂèÇËÄÉ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

https://zenn.dev/numa_san/articles/3de3a8996cd6eb
https://zenn.dev/numa_san/articles/27da6899ade1a7

# „Çµ„É≥„Éó„É´„Ç≥„Éº„Éâ

CancelableAPI„Çí‰Ωø„Å£„Åü„Çµ„É≥„Éó„É´„Ç≥„Éº„Éâ„ÅØ‰ª•‰∏ã„ÅÆ„É™„Éù„Ç∏„Éà„É™„Å´ÁΩÆ„Åç„Åæ„Åó„Åü„ÄÇËààÂë≥„Åå„ÅÇ„ÇãÊñπ„ÅØ„Åú„Å≤Ë¶ã„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

https://github.com/TakanoriOnuma/use-cancelable-api

# ÁµÇ„Çè„Çä„Å´

ÈÄö‰ø°„ÅÆ„Ç≠„É£„É≥„Çª„É´„Å£„Å¶ÁúüÈù¢ÁõÆ„Å´„ÇÑ„Çã„Å®Áõ∏ÂΩì„ÇÅ„Çì„Å©„Åè„Åï„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ„Åü„Å†ÂæåÂõû„Åó„Å´„Åó„Å¶„ÄÅ„ÅÑ„ÅñÂïèÈ°å„ÅåËµ∑„Åç„Å¶ÂØæÂøú„Åó„Å™„Åë„Çå„Å∞„ÅÑ„Åë„Å™„Åè„Å™„Çã„Å®Áõ∏ÂΩìËæõ„ÅÑÊÄù„ÅÑ„Çí„Åô„Çã„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ
‰ªäÂõû„ÅØÊôÆÊÆµ‰Ωø„Å£„Å¶„ÅÑ„Çã„Å®„Åç„ÅØ„ÅÑ„Å§„ÇÇÈÄö„Çä„Å´‰Ωø„Åà„Å¶„ÄÅ„Ç≠„É£„É≥„Çª„É´„Åó„Åü„Åè„Å™„Å£„Åü„ÇâÂÆπÊòì„Å´„Ç≠„É£„É≥„Çª„É´„Åß„Åç„Çã„Çà„ÅÜ„Å™Ë®≠Ë®à„ÇíÂøÉ„Åå„Åë„Åæ„Åó„Åü„ÄÇ„Å≤„Å®„Åà„Å´„Ç≠„É£„É≥„Çª„É´„Å®„ÅÑ„Å£„Å¶„ÇÇÂÖ®„Å¶„Ç≠„É£„É≥„Çª„É´„Åó„Åü„Çä„ÄÅ„ÅÇ„Çã„Ç∞„É´„Éº„Éó„Å†„Åë„Ç≠„É£„É≥„Çª„É´„Åó„Åü„Çä„ÄÅÂÄãÂà•„Åß„Ç≠„É£„É≥„Çª„É´„Åó„Åü„Çä„Å®„ÄÅ„Éë„Çø„Éº„É≥„ÅåÈùûÂ∏∏„Å´Â§ö„Åè‰ΩøÁî®ÊñπÊ≥ï„ÇÇË§áÈõë„Å´„Å™„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü„ÄÇ„Åü„Å†Âü∫Êú¨ÁöÑ„Å´„ÅØ‰Ωø„ÅÑÂãùÊâã„ÅØ„ÅÑ„ÅÑ„Çì„Åò„ÇÉ„Å™„ÅÑ„Åã„Å™„Å®ÊÄù„Å£„Å¶„ÅØ„ÅÑ„Åæ„Åô„ÄÇ
„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅØ‰∏ÄÂøúÂÖ¨Èñã„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„ÅÑ„Å§Ê∂à„Åà„Çã„ÅãÂàÜ„Åã„Çâ„Å™„ÅÑ„ÅÆ„ÅßÂÆüÈÅãÁî®„Åß„ÅØ‰Ωø„Çè„Å™„ÅÑ„Çà„ÅÜ„Å´„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºàÂøµ„ÅÆÁÇ∫Ôºâ„ÄÇ„Åì„Çå„Çífork„Åó„Å¶„Éñ„É©„ÉÉ„Ç∑„É•„Ç¢„ÉÉ„Éó„Åô„ÇãÂàÜ„Å´„ÅØÂÖ®ÁÑ∂ÂïèÈ°å„Å™„ÅÑ„Åß„Åô„ÄÇ
ÁöÜ„Åï„Çì„ÇÇ„Åì„Çå„ÇíÂèÇËÄÉ„Å´ÈÄö‰ø°„Çí„Ç≠„É£„É≥„Çª„É´„Åô„Çã‰ªïÁµÑ„Åø„ÇíËÄÉ„Åà„Å¶„ÅÑ„Åü„Å†„Åë„Åü„ÇâÂπ∏„ÅÑ„Åß„Åô„ÄÇ
