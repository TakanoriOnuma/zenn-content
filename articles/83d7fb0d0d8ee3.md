---
title: "ProseMirrorã§å·®ã—è¾¼ã¿ç”¨ã®ãƒãƒƒãƒ—ã‚’å®Ÿè£…ã—ãŸ"
emoji: "ğŸ—’ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prosemirror"]
published: true
---

## å§‹ã‚ã«

ã‚¨ãƒ‡ã‚£ã‚¿ã§ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãªã©ã€å¾Œã‹ã‚‰å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒå·®ã—è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ãªå‹•çš„ãªã‚‚ã®ã‚’å·®ã—è¾¼ã‚€æ™‚ã«ã€ãƒãƒƒãƒ—ã®ã‚ˆã†ãªã‚‚ã®ã§è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ProseMirrorã§ã¯ç”»åƒã‚’äº‹å‰ã«ä½œã‚‹ã¨å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã§ã€ä»¥ä¸‹ã®è¨˜äº‹ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

https://zenn.dev/wintyo/articles/dad7762bc89301

ã—ã‹ã—ç”»åƒã§ä½œã£ã¦ã—ã¾ã†ã¨ãƒãƒƒãƒ—ãŒé•·ã™ããŸå ´åˆã«3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼ã«å¯¾å¿œã§ããªã‹ã£ãŸã‚Šã€ä¸€ã€…ç”»åƒã‚’äº‹å‰ã«ä½œã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã„å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ProseMirrorã§ã¯ã‚¹ã‚­ãƒ¼ãƒã«åŸºã¥ã„ã¦è‡ªç”±ã«DOMã‚’è¨­å®šã§ãã‚‹ã®ã§spanã‚¿ã‚°ã§è¨­å®šã—ãŸã‚‰ãã‚‚ãã‚‚ç”»åƒã¯ã„ã‚‰ãªã„ã®ã§ã¯ï¼Ÿã¨æ€ã„ã€ãã®è¾ºã®æ¤œè¨¼ã‚’ã—ã¦ã¿ã¾ã—ãŸã€‚æ›´ã«`NodeView`ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã†ã¨ãƒãƒƒãƒ—ãã®ã‚‚ã®ã«è‰²ã€…ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä»•è¾¼ã¿ã‚„ã™ããªã£ãŸã®ã§ã€ãã®è¾ºã«ã¤ã„ã¦ã‚‚è¨˜äº‹ã«ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

### ä½œã£ãŸã‚‚ã®

ä»Šå›æ¤œè¨¼ã§ä½œã£ãŸã‚‚ã®ã‚’å…ˆã«ç´¹ä»‹ã™ã‚‹ã¨2ã¤ã«ãªã‚Šã¾ã™ã€‚

#### ãƒãƒƒãƒ—åå¤‰æ›´å¯èƒ½ã€ã‹ã¤3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œã®ãƒãƒƒãƒ—

ä¸€ã¤ã¯æŒ¿å…¥æ™‚ã«ãƒãƒƒãƒ—åã‚’è‡ªç”±ã«æ±ºã‚ã‚‰ã‚Œã¦ã€ã‹ã¤æ–‡å­—æ•°ãŒå¤šã™ãã‚‹å ´åˆã¯3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼è¡¨ç¤ºã«ãªã‚‹ãƒãƒƒãƒ—ã§ã™ã€‚æ›´ã«ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå‡ºã¦ãƒãƒƒãƒ—ã®æ–‡å­—ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

![](/images/prosemirror-custom-chip/ellipse-chip.gif)

@[stackblitz](https://stackblitz.com/edit/vitejs-vite-f5rvxdgf?ctl=1&embed=1&file=src%2Fmain.ts&view=preview)

#### é¸æŠå¯èƒ½ãªãƒãƒƒãƒ—

äºŒã¤ç›®ã¯ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠè‚¢ã‹ã‚‰é¸ã¹ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒãƒƒãƒ—ã§ã™ã€‚å…ˆé ­ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚„ã‚¢ã‚¤ã‚³ãƒ³ã‚‚ã¤ã‘ã¦ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã—ã¦ã€æ›´ã«ãã®ã‚«ãƒ†ã‚´ãƒªã®ä¸­ã‹ã‚‰é¸æŠã™ã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æƒ³å®šã—ã¦ä½œã‚Šã¾ã—ãŸã€‚

![](/images/prosemirror-custom-chip/selectable-chip.gif)

@[stackblitz](https://stackblitz.com/edit/vitejs-vite-vffelzcb?ctl=1&embed=1&file=src%2Fcomponents%2FEditor%2FEditor.tsx&view=preview)

## ãƒãƒƒãƒ—åå¤‰æ›´å¯èƒ½ã€ã‹ã¤3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œã®ãƒãƒƒãƒ—ã®å®Ÿè£…

æœ€åˆã«ãƒãƒƒãƒ—åå¤‰æ›´å¯èƒ½ã§ã‹ã¤3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œã®ãƒãƒƒãƒ—ã®å®Ÿè£…ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
ProseMirrorã®åŸºæœ¬ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã£ãŸã®ã§ã€ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦å·®åˆ†ã®ã¨ã“ã‚ã ã‘è¨˜ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://zenn.dev/wintyo/articles/dad7762bc89301

### ç”»åƒã§ã¯ãªãspanã‚¿ã‚°ã§ãƒãƒƒãƒ—ã‚’è¡¨ç¾

ä¸Šã®è¨˜äº‹ã§ã¯`toDOM`ã®éƒ¨åˆ†ã§ãƒ©ãƒ™ãƒ«ã‚’ç”»åƒã«å¤‰æ›ã—ã¦è¡¨ç¤ºã•ã›ã¾ã—ãŸãŒã€ãã“ã‚’å˜ç´”ã«spanã‚¿ã‚°ã§å®šç¾©ã™ã‚‹ã“ã¨ã§spanã‚¿ã‚°ã§è¡¨ç¤ºã§ãã¾ã™ã€‚å¾Œã¯ãã“ã«é©åˆ‡ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’å½“ã¦ãŸã‚‰OKã§ã™ã€‚å‰å¾Œã«marginã‚’å…¥ã‚Œã‚‹é–¢ä¿‚ä¸Šspanã‚¿ã‚°ã‚’2ã¤å›²ã£ã¦ãŠã‚Šã¾ã™ã€‚

```diff ts:ç”»åƒã‹ã‚‰spanã‚¿ã‚°ã«å¤‰ãˆã‚‹
 const schema = new Schema({
   nodes: {
     // ä»–ã®Nodeã¯çœç•¥
     chip: {
       inline: true,
       attrs: {
-        name: { default: 'ãƒãƒƒãƒ—' }
+        label: { default: 'ãƒãƒƒãƒ—' }
       },
       group: 'inline',
       draggable: true,
       parseDOM: [
         {
-          tag: 'img[data-chip-name]',
+          tag: 'span.chip',
           getAttrs(dom) {
             if (typeof dom === 'string') {
               return false;
             }
             return {
-              name: dom.getAttribute('data-chip-name')
+              label: dom.textContent
             };
           }
         }
       ],
       toDOM(node) {
-        const chipImageUrl = createChipImage(node.attrs.name);
         return [
-          'img',
+          'span',
-          {
-            src: chipImageUrl,
-            'data-chip-name': node.attrs.name,
-            style: 'height: 25px'
-          }
+          { class: 'chip' },
+          ['span', { class: 'chip__content' }, node.attrs.label]
         ];
       }
     }
   }
 });
```

ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚

```css:ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«
.ProseMirror .chip {
  display: inline-block;
  margin: 2px;
  max-width: 100%;
}

.ProseMirror .chip__content {
  display: inline-block;
  padding: 4px 8px;
  color: #fff;
  background-color: #53b634;
  border-radius: 100vh;
  max-width: 100%;
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: bottom;
  cursor: pointer;
}
```

### ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå‡ºã¦ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

æœ€å¾Œã«ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡ºã—ã¦ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ãŒã€ã“ã‚Œã‚’ã™ã‚‹å ´åˆã¯`NodeView`ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã†ã¨è‰¯ã„ã§ã™ã€‚ã“ã‚Œã¯Nodeã‚¹ã‚­ãƒ¼ãƒã®DOMæç”»ã‚’ã‚ˆã‚Šé«˜åº¦ã«è¡Œãˆã‚‹ã‚ˆã†ã«ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãªã‚Šã¾ã™ã€‚
è©³ã—ã„è¨­å®šã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã—ãŸã®ã§ã€è©³ç´°ã¯ã“ã¡ã‚‰ãªã©ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/mh4gf/articles/d25ef1ff30b5a6#node-views

ã¾ãšã¯ã“ã¡ã‚‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§å…ƒã€…è¡¨ç¤ºã—ã¦ã„ãŸãƒãƒƒãƒ—ã‚’æç”»ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

```ts:NodeViewã‚’ä½¿ã£ã¦ãƒãƒƒãƒ—ã‚’æç”»ã™ã‚‹
import { Node } from 'prosemirror-model';
import { EditorView, NodeView } from 'prosemirror-view';

type DOMNode = InstanceType<typeof window.Node>;
class ChipNodeView implements NodeView {
  dom: DOMNode;

  constructor(node: Node, view: EditorView, getPos: () => number | undefined) {
    const chipElement = document.createElement('span');
    chipElement.classList.add('chip');

    const chipContentElement = document.createElement('span');
    chipContentElement.classList.add('chip__content');
    chipContentElement.textContent = node.attrs.label;

    chipElement.appendChild(chipContentElement);
    this.dom = chipElement;
  }
}
```

ã“ã¡ã‚‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯EditorViewã‚’ç”Ÿæˆã™ã‚‹ã¨ãã«è¨­å®šã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã¨ã“ã‚ã§è¿½åŠ ã—ã¾ã™ã€‚

```diff ts:NodeViewsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç™»éŒ²ã™ã‚‹
 const view = new EditorView(document.getElementById('app'), {
   state,
+  nodeViews: {
+    chip(node, view, getPos) {
+      return new ChipNodeView(node, view, getPos);
+    },
+  },
 });
```

ã“ã‚Œã§DOMã®æç”»ã¯NodeViewã®æ–¹ã§è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€schemaã§å®šç¾©ã—ãŸ`toDOM`ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚ï¼ˆå®šç¾©ã•ã‚Œã¦ã„ã¦ã‚‚ç„¡è¦–ã•ã‚Œã¾ã™ï¼‰

```diff ts:NodeViewã§DOMã‚’æç”»ã™ã‚‹ãŸã‚ã€toDOMã®å‰Šé™¤
 const schema = new Schema({
   nodes: {
     // ä»–ã®Nodeã¯çœç•¥
     chip: {
       inline: true,
       attrs: {
         label: { default: 'ãƒãƒƒãƒ—' }
       },
       group: 'inline',
       draggable: true,
       parseDOM: [
         {
           tag: 'span.chip',
           getAttrs(dom) {
             if (typeof dom === 'string') {
               return false;
             }
             return {
               label: dom.textContent
             };
           }
         }
       ],
-      // ChipNodeViewã§æç”»ã™ã‚‹ãŸã‚ä»¥ä¸‹ã¯ä¸è¦ã«ãªã£ãŸ
-      toDOM(node) {
-        return [
-          'span',
-          { class: 'chip' },
-          ['span', { class: 'chip__content' }, node.attrs.label]
-        ];
-      }
     }
   }
 });
```

å…ˆã»ã©ã®`ChipNodeView`ã¯è¦‹ã¦ã®é€šã‚ŠJSã‚’ã‚´ãƒªã‚´ãƒªæ›¸ã„ã¦ã„ã‘ã°è‰¯ã„ãŸã‚ã€å¾Œã¯addEventListenerã§clickã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å…¥åŠ›ã—ã¦è²°ã£ãŸå¾Œã«æ›´æ–°ç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚‰OKã§ã™ã€‚

```diff ts:ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ãƒ©ãƒ™ãƒ«ã‚’ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
 import { Node } from 'prosemirror-model';
 import { EditorView, NodeView } from 'prosemirror-view';

 type DOMNode = InstanceType<typeof window.Node>;
 class ChipNodeView implements NodeView {
   dom: DOMNode;

   constructor(node: Node, view: EditorView, getPos: () => number | undefined) {
     const chipElement = document.createElement('span');
     chipElement.classList.add('chip');

     const chipContentElement = document.createElement('span');
     chipContentElement.classList.add('chip__content');
     chipContentElement.textContent = node.attrs.label;

     chipElement.appendChild(chipContentElement);
     this.dom = chipElement;

+    this.dom.addEventListener('click', (event) => {
+      const newLabel = window.prompt('ãƒ©ãƒ™ãƒ«ã®æ›´æ–°', node.attrs.label);
+      if (newLabel) {
+        view.dispatch(
+          view.state.tr.setNodeMarkup(getPos() ?? 0, null, {
+            ...node.attrs,
+            label: newLabel,
+          })
+        );
+      }
+      event.preventDefault();
+    });
   }
 }
```

## é¸æŠå¯èƒ½ãªãƒãƒƒãƒ—ã‚’å®Ÿè£…

å…ˆã»ã©ã¯ãƒãƒƒãƒ—ã®ãƒ©ãƒ™ãƒ«ã‚’è‡ªç”±ã«å¤‰æ›´ã§ãã‚‹ã¨ã„ã†ã‚‚ã®ã§ã—ãŸãŒã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯æ±ºã¾ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®å·®ã—è¾¼ã¿è¦ç´ ãŒã‚ã‚Šã€ãã‚Œã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§é¸æŠã§ãã‚‹ã¨è‰¯ã„ã‹ãªã¨æ€ã„ã€ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è©¦ã—ã¾ã—ãŸã€‚ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãªã‚‹ã¨pureãªJSã ã¨å®Ÿè£…ãŒé¢å€’ã«ãªã£ã¦ãã‚‹ã®ã§ã€ã“ã“ã‹ã‚‰ã¯Reactã¨MUIã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚
ãªãŠã€Reactã¨ProseMirrorã®é€£æºã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

https://zenn.dev/wintyo/articles/e2a757ff4e6e51

### Reactã§NodeViewã®ã¨ã“ã‚ã‚’æç”»ã™ã‚‹

æ–°ã—ãæŒ‡å®šã®è¦ç´ ã‚’èµ·ç‚¹ã«Reactã®renderã‚’ã™ã‚‹å ´åˆã€`createRoot`ã§è¦ç´ ã‚’æŒ‡å®šã—ã¦ãã®è¿”ã‚Šå€¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã£ã¦`render`ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚å¿µã®ç‚º`destroy`ãƒ¡ã‚½ãƒƒãƒ‰ã§Reactã‚’ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã™ã‚‹å‡¦ç†ã‚‚æ›¸ã„ã¦ã„ã¾ã™ã€‚

```tsx:Reactã§NodeViewã‚’æç”»ã™ã‚‹å¤§æ ã®å®Ÿè£…
import { createRoot, Root } from 'react-dom/client';
import { Node } from 'prosemirror-model';
import { EditorView, NodeView } from 'prosemirror-view';

export class ChipNodeView implements NodeView {
  dom: HTMLElement;
  reactRoot: Root;

  constructor(node: Node, view: EditorView, getPos: () => number | undefined) {
    this.dom = document.createElement('span');

    this.reactRoot = createRoot(this.dom);

    this.reactRoot.render(
      // ãƒãƒƒãƒ—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æç”»ã™ã‚‹
    );
  }

  destroy() {
    // ä»¥ä¸‹ã®è­¦å‘ŠãŒå‡ºã¦ã—ã¾ã†ã®ã§ãƒ¯ãƒ³ã‚µã‚¤ã‚¯ãƒ«ç½®ã„ã¦ã‹ã‚‰unmountã™ã‚‹
    // Attempted to synchronously unmount a root while React was already rendering.
    // React cannot finish unmounting the root until the current render has completed, which may lead to a race condition.
    // @see https://stackoverflow.com/questions/73459382/react-18-async-way-to-unmount-root
    setTimeout(() => {
      this.reactRoot.unmount();
    }, 0);
  }
}
```

### é¸æŠå¯èƒ½ãªãƒãƒƒãƒ—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…

ä»Šå›ãƒãƒƒãƒ—ã®ç¨®é¡ã¯ `'user' | 'form'` ã®2ç¨®é¡ã‚’ç”¨æ„ã—ã€ `'form'` ã®æ™‚ã ã‘ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§é¸æŠã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚æ›´ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚„èƒŒæ™¯è‰²ãŒå¤‰ã‚ã‚‹ã‚ˆã†ã«ã‚¯ãƒ©ã‚¹åã‚’æ¡ä»¶åˆ†å²ã§åˆ‡ã‚Šæ›¿ãˆãªãŒã‚‰å®Ÿè£…ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸã€‚
ã¡ãªã¿ã«ã€ã‚¢ã‚¤ã‚³ãƒ³ã¯`Material Design Icon`ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§importã—ã¦`mdi-*`ã®ã‚¯ãƒ©ã‚¹åã‚’ã¤ã‘ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚

https://pictogrammers.com/docs/library/mdi/getting-started/webfont/

```tsx:ãƒãƒƒãƒ—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
import { FC, ReactNode, useState, MouseEvent as ReactMouseEvent } from 'react';
import { Box, Menu, MenuItem } from '@mui/material';

import { FORM_OPTIONS } from '../../constants/FormOptions';

export type EditorChipProps = {
  /** ãƒãƒƒãƒ—ç¨®åˆ¥ */
  type: 'user' | 'form';
  /** å€¤ */
  value?: number | null;
  /**
   * å€¤æ›´æ–°æ™‚
   * @param newValue - æ–°ã—ã„å€¤
   */
  onChangeValue: (newValue: number) => void;
  /** å­è¦ç´  */
  children: ReactNode;
};

export const EditorChip: FC<EditorChipProps> = ({
  type,
  value,
  onChangeValue,
  children,
}) => {
  const [elAnchor, setElAnchor] = useState<HTMLElement | null>(null);

  const handleClick =
    type === 'form'
      ? (event: ReactMouseEvent<HTMLElement>) => {
          setElAnchor(event.currentTarget);
        }
      : undefined;

  return (
    <>
      <Box component="span" className={`chip -${type}`}>
        <Box
          component="span"
          className={`chip__content mdi ${
            type === 'form' ? 'mdi-text-box-outline' : 'mdi-account'
          }`}
          sx={
            handleClick
              ? {
                  cursor: 'pointer',
                }
              : undefined
          }
          onClick={handleClick}
        >
          {children}
          {handleClick && <span className="mdi mdi-chevron-down" />}
        </Box>
      </Box>
      {handleClick && (
        <Menu
          open={elAnchor != null}
          anchorEl={elAnchor}
          MenuListProps={{
            dense: true,
          }}
          onClose={() => {
            setElAnchor(null);
          }}
        >
          {FORM_OPTIONS.map((option) => (
            <MenuItem
              key={option.value}
              selected={option.value === value}
              onClick={() => {
                onChangeValue(option.value);
                setElAnchor(null);
              }}
            >
              {option.label}
            </MenuItem>
          ))}
        </Menu>
      )}
    </>
  );
};
```

ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã¾ãŸæœ€åˆã®æ™‚ã¯`.ProseMirror`ã®å­å­«ã‚’æ¡ä»¶ã«ã—ã¦ã„ã¾ã—ãŸãŒã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹éš›ã«ã‚¹ã‚¿ã‚¤ãƒ«ãŒå½“ãŸã‚‰ãªããªã‚‹ã®ã§å¤–ã—ã¾ã—ãŸã€‚

```diff css:ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒƒãƒ—ã®å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
 .chip {
   display: inline-block;
   margin: 2px;
   max-width: 100%;
 }

 .chip__content {
   display: inline-block;
   padding: 4px 8px;
   color: #fff;
   background-color: #53b634;
   border-radius: 100vh;
   max-width: 100%;
   line-height: 1;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   vertical-align: bottom;
 }

+.chip.-form .chip__content {
+  background-color: #1976d2;
+}
```

æœ€å¾Œã«ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’`ChipNodeView`ã§renderã—ãŸã‚‰å®Œæˆã§ã™ã€‚ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®é–¢ä¿‚ä¸Š`inline-block`ã«ã—ãªã„ã¨ä¸Šä¸‹ã®ä½ç½®ãŒå¤‰ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§renderå…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚å°‘ã—è¶³ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸ`max-width`ã¯3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼ã«ã™ã‚‹ãŸã‚åˆã‚ã›ã¦è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã†ã„ã†ã“ã¨ãŒã‚ã‚‹ã®ã§ç†æƒ³ã¯Reactã§æç”»ã—ãŸã‚‚ã®ã ã‘ã«ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€ã©ã†ã—ã¦ã‚‚rootã«ãªã‚‹ã‚‚ã®ã¯æ®‹ã•ãªã„ã¨ã„ã‘ãªãã†ãªé›°å›²æ°—ã ã£ãŸã®ã§ä»•æ–¹ãªãã“ã®ã‚ˆã†ãªå¯¾å¿œã«ã—ã¦ã„ã¾ã™ã€‚

```diff tsx:ChipNodeViewã§ä½œæˆã—ãŸãƒãƒƒãƒ—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æç”»ã™ã‚‹
 import { createRoot, Root } from 'react-dom/client';
 import { Node } from 'prosemirror-model';
 import { EditorView, NodeView } from 'prosemirror-view';
+import { EditorChip } from '../EditorChip';

+import { FORM_OPTIONS } from '../../constants/FormOptions';

 export class ChipNodeView implements NodeView {
   dom: HTMLElement;
   reactRoot: Root;

   constructor(node: Node, view: EditorView, getPos: () => number | undefined) {
     this.dom = document.createElement('span');
+    this.dom.style.display = 'inline-block';
+    this.dom.style.maxWidth = '100%';

     this.reactRoot = createRoot(this.dom);

     this.reactRoot.render(
+      <EditorChip
+        type={node.attrs.type}
+        value={node.attrs.value}
+        onChangeValue={(newValue) => {
+          const option = FORM_OPTIONS.find((opt) => opt.value === newValue);
+          view.dispatch(
+            view.state.tr.setNodeMarkup(getPos() ?? 0, null, {
+              ...node.attrs,
+              value: newValue,
+              label: option?.label,
+            })
+          );
+        }}
+      >
+        {node.attrs.label}
+      </EditorChip>
     );
   }

   // destroyãƒ¡ã‚½ãƒƒãƒ‰ã¯åŒã˜ãªã®ã§çœç•¥
 }
```

### ãã®ä»–: ç·¨é›†ç”¨ã®DOMã‚’å–ã‚Šé™¤ã„ãŸHTMLã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•

ä»¥ä¸Šã§åŸºæœ¬å®Ÿè£…ã¯çµ‚ã‚ã‚Šã§ã™ãŒã€æœ€çµ‚çš„ãªHTMLã‚’å‡ºåŠ›ã™ã‚‹éš›ã«ã‚¨ãƒ‡ã‚£ã‚¿ã®DOMã‚’ãã®ã¾ã¾ä½¿ã†ã¨`NodeView`ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§æç”»ã—ãŸç·¨é›†ç”¨ã®DOMã‚‚ãã®ã¾ã¾å‡ºåŠ›ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ã“ã‚Œã‚’å›é¿ã™ã‚‹å ´åˆã¯schemaã®æ–¹ã§`toDOM`ã‚’å®šç¾©ã—ã€`DOMSerializer`ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚äºŒé‡ç®¡ç†ã«ãªã£ã¦ã—ã¾ã„ãã†ã§ã™ãŒã€ãã‚‚ãã‚‚ç·¨é›†ä¸­ã®DOMã¨å®Œæˆç‰ˆã®HTMLãƒ†ã‚­ã‚¹ãƒˆã¯åˆ¥ç‰©ã ã¨æ€ã†ã®ã§ä»•æ–¹ãªã„ã®ã‹ãªã¨æ€ã£ã¦ã¾ã™ã€‚ä»Šå›ã¯ã‚„ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€ã§ãã‚‹ã ã‘å·®åˆ†ã‚’æ¸›ã‚‰ã™ãŸã‚ã«å…±é€šã®æç”»ãƒ¡ã‚½ãƒƒãƒ‰ã‚’é€šã™ãªã©ã‚’ã™ã‚‹ã¨äºŒé‡ç®¡ç†ã®è² æ‹…ã¯è»½æ¸›ã•ã‚Œã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã—ãŸğŸ¤”

```diff tsx:DOMSerializerã‚’ä½¿ã£ã¦HTMLãƒ†ã‚­ã‚¹ãƒˆã‚’å‡ºåŠ›ã™ã‚‹
 import { Schema, Node, DOMParser, DOMSerializer } from 'prosemirror-model';

 const schema = new Schema({
   nodes: {
     // ä»–ã®Nodeã¯çœç•¥
     chip: {
       inline: true,
       attrs: {
         type: { default: 'user' },
         value: { default: null },
         label: { default: 'ãƒãƒƒãƒ—' },
       },
       group: 'inline',
       draggable: true,
       parseDOM: [
         {
           tag: 'span.chip',
           getAttrs(dom) {
             if (typeof dom === 'string') {
               return false;
             }
             const parseNumber = (str: string | null) => {
               if (str == null) {
                 return null;
               }
               const value = parseInt(str);
               return Number.isNaN(value) ? null : value;
             };
             return {
               type: dom.classList.contains('-form') ? 'form' : 'user',
               value: parseNumber(dom.getAttribute('data-value')),
               label: dom.textContent,
             };
           },
         },
       ],
+      // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºç”¨ã«å¾©æ´»ã•ã›ã‚‹
+      toDOM(node) {
+        return [
+          'span',
+          { class: `chip -${node.attrs.type}`, 'data-value': node.attrs.value },
+          [
+            'span',
+            {
+              class: `chip__content mdi ${
+                node.attrs.type === 'form'
+                  ? 'mdi-text-box-outline'
+                  : 'mdi-account'
+              }`,
+            },
+            node.attrs.label,
+          ],
+        ];
+      },
     },
   },
 });

 export const Editor: FC<EditorProps> = ({
   initialValue = '',
   onChangeValue,
 }) => {
   const [_, forceUpdate] = useReducer((x) => x + 1, 0);
   const elContentRef = useRef<HTMLDivElement | null>(null);
   const editorViewRef = useRef<EditorView>();

   useEffect(() => {
     const doc = createDoc(initialValue, schema);
     const state = createPmState(schema, { doc });
+    const serializer = DOMSerializer.fromSchema(schema);

     const editorView = new EditorView(elContentRef.current, {
       state,
       nodeViews: {
         chip(node, view, getPos) {
           return new ChipNodeView(node, view, getPos);
         },
       },
       dispatchTransaction(transaction) {
         const newState = editorView.state.apply(transaction);
         editorView.updateState(newState);

-        onChangeValue(editorView.dom.innerHTML)
-        forceUpdate();
+        const newHtml = serializer.serializeFragment(
+          newState.doc.content,
+          undefined,
+          document.createElement('div')
+        );
+        if (newHtml instanceof HTMLElement) {
+          onChangeValue(newHtml.innerHTML);
+          forceUpdate();
+        }
       },
     });
     editorViewRef.current = editorView;
     forceUpdate();

     return () => {
       editorView.destroy();
       editorViewRef.current = undefined;
     };
   }, []);

   return (
     // çœç•¥
   )
 }
```

## çµ‚ã‚ã‚Šã«

ä»¥ä¸ŠãŒProseMirrorã‚’ä½¿ã£ã¦ç·¨é›†å¯èƒ½ãªå·®ã—è¾¼ã¿ç”¨ãƒãƒƒãƒ—ã®å®Ÿè£…æ–¹æ³•ã§ã—ãŸã€‚ãƒãƒƒãƒ—ã‚’ç›´æ¥ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã‹ãªã‚Šè¡¨ç¾ã®å¹…ãŒåºƒãŒã‚‹ã¨æ€ã†ã®ã§ã€ã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã—ãŸã„æ™‚ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
