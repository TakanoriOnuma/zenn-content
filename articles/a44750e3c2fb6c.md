---
title: "ä¸€ã¤ã®ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã«è¤‡æ•°ã®æƒ…å ±ã‚’è©°ã‚è¾¼ã‚“ã type safeãªhooksã‚’ä½œã£ãŸ"
emoji: "ğŸ›ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript", "reactrouter", "contest2025ts"]
published: true
---

## å§‹ã‚ã«

ã‚¿ãƒ–ã‚„ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ãªã©ã€ã‚¯ã‚¨ãƒªã«æƒ…å ±ã‚’æŒãŸã›ã‚‹ã“ã¨ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚çŠ¶æ…‹ãŒæ®‹ã£ã¦ã„ãŸã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã§å‰ã®çŠ¶æ…‹ã«æˆ»ã‚Œã‚‹ãªã©ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã‚¯ã‚¨ãƒªã«ãŸãã•ã‚“æƒ…å ±ã‚’æŒãŸã›ã‚‹ã¨ã©ã“ã§ã©ã†ã„ã†ã‚±ãƒ¼ã‚¹ã§ä½¿ã‚ã‚Œã‚‹ã‚‚ã®ã‹åˆ†ã‹ã‚Šã¥ã‚‰ããªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ç‰¹å®šã®ã‚¿ãƒ–ã®ä¸­ã§ä½¿ã‚ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãã‚Œãã‚Œã‚¯ã‚¨ãƒªã§ç®¡ç†ã™ã‚‹ã¨è©²å½“ã®ã‚¿ãƒ–ãŒéè¡¨ç¤ºãªã®ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®æƒ…å ±ãŒæ®‹ã£ã¦ã„ã‚‹ãªã©ãƒã‚°ãƒã‚°ãªã“ã¨ãŒèµ·ãã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚é€£å‹•ã—ã¦ä½¿ã‚ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸€ã¤ã®ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã«è©°ã‚è¾¼ã¾ã‚Œã¦ã„ãŸæ–¹ãŒãã†ã„ã†çŸ›ç›¾ãŒãªããªã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä¸€ã¤ã®ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã«è¤‡æ•°ã®æƒ…å ±ã‚’è©°ã‚è¾¼ã‚€å ´åˆã¯ã€ãƒ‘ãƒ¼ã‚¹ã¨ã‚¯ã‚¨ãƒªã«ä¿å­˜ã™ã‚‹hooksã‚’ä½œã£ã¦ãŠãã“ã¨ã§å‘¼ã³å‡ºã—å´ã¯æ°—è»½ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

```ts:ã‚¿ãƒ–å€¤ã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒšã‚¢ã«ã—ã¦ã‚¯ã‚¨ãƒªå€¤ã§ç®¡ç†ã™ã‚‹hooks
import { useSearchParams } from 'react-router';
import { useMemo, useCallback } from 'react';

type TabAndPagination = {
  tab: string
  page: number
}

const useTabAndPaginationQueryValue = (queryKey: string) => {
  const [searchParams, setSearchParams] = useSearchParams();
  const tabAndPagination: TabAndPagination | null = useMemo(() => {
    const queryStr = searchParams.get(queryKey);
    if (typeof queryStr !== 'string') {
      return null
    }
    const [tab, pageStr] = queryStr.split('_');
    return { tab, page: parseInt(pageStr) };
  }, [queryKey, searchParams]);

  const updateTabAndPagination = useCallback(
    (newTabAndPagination: TabAndPagination | null) => {
      setSearchParams((prevSearchParams) => {
        if (newTabAndPagination == null) {
          prevSearchParams.delete(queryKey);
          return prevSearchParams;
        }

        prevSearchParams.set(
          queryKey,
          [newTabAndPagination.tab, newTabAndPagination.page].join('_')
        );
        return prevSearchParams;
      });
    }, 
    [queryKey, setSearchParams]
  );

  return {
    tabAndPagination,
    updateTabAndPagination,
  };
}
```

ãŸã ã“ã®æ›¸ãæ–¹ã ã¨ã‹ãªã‚Šé™å®šã•ã‚ŒãŸã‚±ãƒ¼ã‚¹ã§ã—ã‹ä½¿ç”¨ã§ããšã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã”ã¨ã«hooksã‚’ä½œã‚‹å¿…è¦ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã¾ãŸä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ç°¡æ˜“çš„ãªã‚‚ã®ã§å…¨ã¦ã®ã‚¿ãƒ–ã«å¯¾ã—ã¦ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸è¦ãªå ´åˆã¯æœªè¨­å®šã«ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã¨ã‚ˆã‚Šè¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚
ã“ã®å•é¡Œã¯ä»¥å‰ä½œã£ãŸã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã®è¡¨ç¤ºã§ä½¿ã†ã‚¯ã‚¨ãƒªå€¤ã«ã‚‚å½“ã¦ã¯ã¾ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®è¨˜äº‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä¾‹ã«ã™ã‚‹ã¨ã€`{ type: 'setting' }`ã¨`{ type: 'sentence'; page: number }`ã®ã©ã¡ã‚‰ã‹ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

https://zenn.dev/castingone_dev/articles/react_side_peak

ã“ã†ã—ãŸè¤‡é›‘ã«ãªã‚‹å®Ÿè£…ã«å¯¾ã—ã¦ã€ã‚ˆã‚Šæ±ç”¨çš„ãªå…±é€šã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¦ã©ã†ã„ã†é¢¨ã«ãƒ‘ãƒ¼ã‚¹ãƒ»ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—åŒ–ã™ã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§æœŸå¾…ã™ã‚‹å€¤ã§type safeã«æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ãŸhooksã‚’ä½œã‚Šã¾ã—ãŸã®ã§ã€ãã®å®Ÿè£…å†…å®¹ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

## ä¸€ã¤ã®ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã«è¤‡æ•°ã®æƒ…å ±ã‚’è©°ã‚è¾¼ã‚“ã type safeãªhooksã®å®Ÿè£…

ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã‚’ä¾‹ã«æŒ™ã’ã‚‹ã¨ã€ãƒ‘ãƒ¼ã‚¹å¾Œã®çµæœã‚’`{ type: 'setting' }`ã¨`{ type: 'sentence'; page: number }`ã®ã‚ˆã†ãªå½¢ã«ã§ãã‚‹ã‚ˆã†ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã©ã®ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã‚’ä½¿ã†ã‹ã¯`type`ã§ç®¡ç†ã—ã€ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã§è¿½åŠ ã™ã‚‹å½¢ã«ãªã‚‹ã¨è‰¯ã•ãã†ã§ã™ã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«è¦ç´ ã¯æœ€çµ‚çš„ã«ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’ã™ã‚‹éš›ã«è¿”ã™å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãã“ã‹ã‚‰åˆ¤æ–­ã§ããã†ã§ã™ã€‚ã¾ã¨ã‚ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã®å–ã‚Šå¾—ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã®å–ã‚Šå¾—ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³é…åˆ—
const parsePageNumber = (pageStr?: string | null) => {
  if (typeof pageStr !== 'string') {
    return undefined;
  }
  if (!/^[0-9]+$/.test(pageStr)) {
    return undefined;
  }
  return parseInt(pageStr);
};

// ã“ã®é…åˆ—ã‚’ä½¿ã£ã¦ type SidePeakValue = { type: 'setting' } | { type: 'sentence'; page: number } ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
const SIDE_PEAK_PATTERNS = [
  { type: 'setting' },
  {
    type: 'sentence',
    // ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‹ã‚‰ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã«ã™ã‚‹
    parser: (queryStr) => {
      const page = parsePageNumber(queryStr);
      return page != null ? { page } : null;
    },
    // ã‚¯ã‚¨ãƒªã«ä¿å­˜ã™ã‚‹ãŸã‚ã®æ–‡å­—åˆ—åŒ–ï¼ˆtypeã¯å…±é€šã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ãã‚Œä»¥å¤–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿æ–‡å­—åˆ—åŒ–ï¼‰
    stringify: (payload) => {
      return `${payload.page}`;
    }
  },
]
```

ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«æ±ç”¨çš„ãªhooksã‚’ä½œã£ã¦ã„ãã¾ã™ãŒã€å‹ã®ç®—å‡ºãŒã‹ãªã‚Šé›£ã—ã„ã¨ã“ã‚ãªã®ã§ã€ãã¡ã‚‰ã‚’é‡ç‚¹çš„ã«èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

### typeã®ã¿ã¨parserè¾¼ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹å®šç¾©

ã¾ãšã¯å¼•æ•°ã«æ¸¡ã™ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚typeã®ã¿ã¨parserã¨stringifyã‚‚æ¸¡ã™å ´åˆãŒã‚ã‚‹ãŸã‚ã€æ¡ä»¶åˆ†å²ã‚’ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts:ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã®å–ã‚Šå¾—ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹
type IsEmptyObject<T> = [keyof T] extends [never] ? true : false;

/** ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã®å–ã‚Šå¾—ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ */
export type ParsedQueryValuePattern<
  /** ã‚¯ã‚¨ãƒªã®ç¨®åˆ¥ */
  Type extends string,
  /** ã‚¯ã‚¨ãƒªãƒ‡ãƒ¼ã‚¿ */
  Payload extends object = {}
> = IsEmptyObject<Payload> extends true
  ? {
      /** ã‚¯ã‚¨ãƒªã®ç¨®åˆ¥ */
      type: Type;
    }
  : {
      /** ã‚¯ã‚¨ãƒªã®ç¨®åˆ¥ */
      type: Type;
      /**
       * ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‹ã‚‰ã‚¯ã‚¨ãƒªå€¤ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ï¼ˆãƒ‘ãƒ¼ã‚¹ã§ããªã„æ™‚ã¯nullã‚’è¿”ã™ï¼‰
       * @param queryStr - ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—
       */
      parser: (queryStr: string) => Payload | null;
      /**
       * ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®æ–‡å­—åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
       * @param payload - ã‚¯ã‚¨ãƒªå€¤
       */
      stringify: (payload: Payload) => string;
    };
```

ä¾‹ã«æŒ™ã’ãŸãƒ‘ã‚¿ãƒ¼ãƒ³é…åˆ—ã«ã“ã®å‹ã‚’ä½¿ã†å ´åˆã¯ã€ãã‚Œãã‚Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆ†ã‘ã¦å®šç¾©ã™ã‚‹ã¨è‰¯ã•ãã†ã§ã™ã€‚

```ts:ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã®å–ã‚Šå¾—ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å‹ã‚’å½“ã¦ã‚‹
const SETTING_SIDE_PEAK_PATTERN: ParsedQueryValuePattern<'setting'> = {
  type: 'setting',
};

const SENTENCE_SIDE_PEAK_PATTERN: ParsedQueryValuePattern<
  'sentence',
  { page: number }
> = {
  type: 'sentence',
  parser: (queryStr) => {
    const page = parsePageNumber(queryStr);
    return page != null ? { page } : null;
  },
  stringify: (payload) => {
    return `${payload.page}`;
  },
};
```

### ãƒ‘ãƒ¼ã‚¹å¾Œã®å‹ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ç®—å‡ºã™ã‚‹

ç¶šã„ã¦ã¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå€¤ã®å‹ã‚’ç®—å‡ºã—ã¾ã™ã€‚ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹ã¯parserãŒãªã„ã‚‚ã®ã¨ã‚ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€ãã‚Œãã‚Œã®ã‚±ãƒ¼ã‚¹ã§å‹ã‚’ç®—å‡ºã—ã¾ã™ã€‚

```ts:å˜ä¸€ã®ParsedQueryPatternã‹ã‚‰ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤ã‚’å–å¾—ã™ã‚‹
/** { a: number } & { b: string } ã‚’ { a: number; b: string } ã®ã‚ˆã†ã«å˜ç´”ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã«æ•´ç†ã™ã‚‹ */
type Simplify<T> = { [K in keyof T]: T[K] };

/** ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§ä½¿ç”¨ã™ã‚‹å—ã‘å…¥ã‚Œå¯èƒ½ãªå‹ */
type AllowParsedQueryValuePattern =
  | ParsedQueryValuePattern<string>
  | ParsedQueryValuePattern<string, any>;

/** å˜ä¸€ã®ParsedQueryPatternã‹ã‚‰ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤ã‚’å–å¾—ã™ã‚‹ */
type SingleParsedQueryValue<Pattern extends AllowParsedQueryValuePattern> =
  Pattern extends ParsedQueryValuePattern<string, any>
    ? Simplify<{ type: Pattern['type'] } & ReturnType<Pattern['parser']>>
    : Pattern extends ParsedQueryValuePattern<string>
    ? { type: Pattern['type'] }
    : never;
```

ã“ã‚Œã§ãã‚Œãã‚Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é©åˆ‡ãªã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã®å€¤ãŒç®—å‡ºã•ã‚Œã¾ã™ã€‚

```ts:SingleParsedQueryValueã§å–å¾—ã•ã‚Œã‚‹å‹ã®ä¾‹
type SettingSidePeakValue = SingleParsedQueryValue<typeof SETTING_SIDE_PEAK_PATTERN>
// { type: 'setting' }

type SentenceSidePeakValue = SingleParsedQueryValue<typeof SENTENCE_SIDE_PEAK_PATTERN>
// { type: 'sentence'; page: number }
```

ã“ã‚Œã‚’è¤‡æ•°ç‰ˆã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã€å†å¸°ã‚’ä½¿ã£ã¦ä¸€ã¤ãšã¤ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:è¤‡æ•°ã®ParsedQueryPatternã‹ã‚‰ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤ã‚’å–å¾—ã™ã‚‹
/** è¤‡æ•°ã®ParsedQueryPatternã‹ã‚‰ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤ã‚’å–å¾—ã™ã‚‹ */
type MultipleParsedQueryValue<
  Patterns extends readonly AllowParsedQueryValuePattern[]
> = Patterns extends readonly [
  infer Head extends AllowParsedQueryValuePattern,
  ...infer Rest extends readonly AllowParsedQueryValuePattern[]
]
  ? SingleParsedQueryValue<Head> | MultipleParsedQueryValue<Rest>
  : never;
```

### äº‹å‰ã«ä½œã£ãŸå‹ã‚’ä½¿ã£ã¦hooksã‚’å®Ÿè£…

ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ‘ãƒ¼ã‚¹å¾Œã®å‹ãŒã§ããŸã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦hooksã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã®å½¢å¼ã¯ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã®typeã¨è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—åˆ—åŒ–ã—ãŸã‚‚ã®ã‚’`_`ã§çµåˆã—ãŸã‚‚ã®ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚ä¾‹ã§æŒ™ã’ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã†ã¨ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

- `SETTING_SIDE_PEAK_PATTERN`: `setting`
- `SENTENCE_SIDE_PEAK_PATTERN`: `sentence_1`

ã“ã®å½¢å¼ã§å‹•ãã‚ˆã†ã«parseã€stringifyã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```ts:ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã‚’ç®¡ç†ã™ã‚‹hooks
/**
 * ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã‚’ç®¡ç†ã™ã‚‹hooks
 * @param queryKey - å‚ç…§ã™ã‚‹ã‚¯ã‚¨ãƒªã‚­ãƒ¼
 * @param patterns - ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã®å–ã‚Šå¾—ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
 */
export const useParsedQueryValue = <
  Patterns extends readonly AllowParsedQueryValuePattern[]
>(
  queryKey: string,
  patterns: Patterns
) => {
  const [searchParams, setSearchParams] = useSearchParams();

  const parsedQueryValue: MultipleParsedQueryValue<Patterns> | null =
    useMemo(() => {
      const queryStr = searchParams.get(queryKey);
      if (typeof queryStr !== 'string') {
        return null;
      }
      for (const pattern of patterns) {
        if (queryStr.startsWith(pattern.type)) {
          if ('parser' in pattern === false) {
            return { type: pattern.type };
          }
          // `${type}_` ã®éƒ¨åˆ†ã‚’å–ã‚Šé™¤ã„ãŸéƒ¨åˆ†ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
          const payload = pattern.parser(
            queryStr.slice(pattern.type.length + 1)
          );
          if (payload == null) {
            console.warn('ã‚¯ã‚¨ãƒªå€¤ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:', queryStr);
            return null;
          }
          return { type: pattern.type, ...payload };
        }
      }
      // æœ€å¾Œã¾ã§ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆ
      console.warn(`ã‚¯ã‚¨ãƒªã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã—ã¾ã›ã‚“ã§ã—ãŸ:`, queryStr);
      return null;
    }, [queryKey, patterns, searchParams]);

  const updateParsedQueryValue = useCallback(
    (value: MultipleParsedQueryValue<Patterns> | null) => {
      setSearchParams((prevSearchParams) => {
        if (value == null) {
          prevSearchParams.delete(queryKey);
          return prevSearchParams;
        }

        for (const pattern of patterns) {
          if (pattern.type === value.type) {
            if ('stringify' in pattern === false) {
              prevSearchParams.set(queryKey, pattern.type);
              return prevSearchParams;
            }

            const str = pattern.stringify(value);
            // typeã¨æ–‡å­—åˆ—ã—ãŸå€¤ã‚’_ã§çµåˆã—ã¦ã‚¯ã‚¨ãƒªã«ä¿å­˜ã™ã‚‹
            prevSearchParams.set(queryKey, `${pattern.type}_${str}`);
            return prevSearchParams;
          }
        }

        // æœ€å¾Œã¾ã§ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆ
        console.warn('ã‚¯ã‚¨ãƒªã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã—ã¾ã›ã‚“ã§ã—ãŸ:', value);
        return prevSearchParams;
      });
    },
    [queryKey, patterns, setSearchParams]
  );

  return {
    /** ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ */
    parsedQueryValue,
    /**
     * ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã‚’æ›´æ–°ï¼ˆã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’æ›´æ–°ã™ã‚‹ï¼‰
     * @param value - ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤
     */
    updateParsedQueryValue,
  };
};
```

### ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã¨ã—ã¦ä½¿ã†

ã‚ã¨ã¯ã“ã®hooksã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚ã¦ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ç”¨ã®hooksã«ã—ã¾ã™ã€‚æŠ˜è§’ãªã®ã§åå‰ã‚‚ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã«å¯„ã›ãŸåå‰ã«ãƒªãƒãƒ¼ãƒ ã—ã¦è¿”ã—ã¾ã™ã€‚

```ts:ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã‚’ç®¡ç†ã™ã‚‹hooks
const SIDE_PEAK_PATTERNS = [
  SETTING_SIDE_PEAK_PATTERN,
  SENTENCE_SIDE_PEAK_PATTERN,
] as const;

/**
 * ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã‚’ç®¡ç†ã™ã‚‹hooks
 */
export const useSidePeakValue = () => {
  const {
    parsedQueryValue: sidePeakValue,
    updateParsedQueryValue: updateSidePeakValue,
  } = useParsedQueryValue('sidePeak', SIDE_PEAK_PATTERNS);

  return {
    /** ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ */
    sidePeakValue,
    /**
     * ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤ã®æ›´æ–°
     * @param value - ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯å€¤
     */
    updateSidePeakValue,
  };
};
```

å¾Œã¯ã“ã®hooksã‚’ä½¿ã£ã¦å€¤ã‚’æ›´æ–°ã™ã‚‹ã ã‘ã§OKã§ã™ã€‚ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã®å®Ÿè£…ã®éš›ã«ä½¿ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦å·®ã—æ›¿ãˆã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰ã‚ã‚Šã¾ã™ã€‚

```diff tsx:useSidePeakValueã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
 const HomePage: FC = () => {
-  const [searchParams] = useSearchParams();
-
-  const sidePeakType = searchParams.get('sidePeak');
-  const paramPage = parsePageNumber(searchParams.get('page'));
+  const { sidePeakValue, updateSidePeakValue } = useSidePeakValue();
 
   return (
     <div>
       <h3>HOMEç”»é¢</h3>
       <Stack alignItems="flex-start" spacing={1}>
         <Button
-          component={NavLink}
-          variant={sidePeakType === 'setting' ? 'contained' : 'outlined'}
-          to="?sidePeak=setting"
+          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã§å®Ÿè£…ã€‚ãƒªãƒ³ã‚¯ã§ã‚„ã‚‹å ´åˆã¯å¾Œè¿°
+          variant={sidePeakValue?.type === 'setting' ? 'contained' : 'outlined'}
+          onClick={() => {
+            updateSidePeakValue({
+              type: 'setting',
+            });
+          }}
         >
           è¨­å®šç”»é¢ã‚’ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã§é–‹ã
         </Button>
         <Box sx={{ pt: 2 }}>
           <Box>æ–‡ç« ãƒšãƒ¼ã‚¸ã‚’ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã§é–‹ã</Box>
           <Stack direction="row" useFlexGap flexWrap="wrap" spacing={0.5}>
             {Array.from({ length: 5 }).map((_, i) => {
               const page = i + 1;
-              const isActive =
-                sidePeakType === 'sentence' && page === paramPage;
+              const isActive =
+                sidePeakValue?.type === 'sentence' &&
+                sidePeakValue.page === page;
               return (
                 <Button
                   key={i}
-                  component={NavLink}
                   variant={isActive ? 'contained' : 'outlined'}
-                  to={`/?sidePeak=sentence&page=${page}`}
+                  onClick={() => {
+                    updateSidePeakValue({
+                      type: 'sentence',
+                      page,
+                    });
+                  }}
                 >
                   ãƒšãƒ¼ã‚¸{page}
                 </Button>
              );
             })}
           </Stack>
         </Box>
       </Stack>
       <SidePeakEntry />
     </div>
   )
 }
```

## ãã®ä»–

ä»¥ä¸ŠãŒæœ€ä½é™ã®å®Ÿè£…ã§ã™ãŒã€ã‚ˆã‚Šè‰²ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã‚„ã£ãŸã“ã¨ã‚’è¼‰ã›ã¾ã™ã€‚

### ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã®å€¤ã‚’æ›´æ–°ã§ã¯ãªãURLã«è¶³ã›ã‚‹ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹

å…ƒã€…ã®ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’è¨­å®šã—ã¦ãƒªãƒ³ã‚¯ã¨ã—ã¦å‹•ã„ã¦ã„ã¾ã—ãŸã€‚ã‚µã‚¤ãƒ‰ãƒ”ãƒ¼ã‚¯ã¯ãƒªãƒ³ã‚¯ã¨ã„ã†ã‚ˆã‚Šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå¼·ã„ã®ã§ã‚ã–ã‚ã–ãƒªãƒ³ã‚¯ã«ã™ã‚‹å¿…è¦ã‚‚ãªã„ã¨æ€ã„ã¾ã™ãŒã€ä»–ã®ã‚±ãƒ¼ã‚¹ã ã¨å¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚åŸºæœ¬çš„ã«ã¯`updateParsedQueryValue`ã§prevSearchParamsã‚’æ›´æ–°ã™ã‚‹ç›´å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’`toString()`ã—ãŸã‚‰ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã¯å–å¾—ã§ãã‚‹ã®ã§ã€ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚searchParamsã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã¯ä»–ã®ã‚¯ã‚¨ãƒªå€¤ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã‚‚è€ƒæ…®ã—ã¦æœ€çµ‚çš„ãªã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’è¿”ã™ãŸã‚ã§ã™ã€‚ã“ã®hooksã«é–¢ã‚ã£ã¦ã„ã‚‹æ–‡å­—åˆ—ã ã‘è¿”ã™æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€ãã®å¾Œã«çµåˆä½œæ¥­ãŒå¿…è¦ã«ãªã‚‹ã®ã¯æµçŸ³ã«é¢å€’ã‹ãªã¨æ€ã£ã¦ä¸€ç·’ã®ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ã‚„ã‚Šã¾ã›ã‚“ãŒã‚‚ã£ã¨ä¸å¯§ã«ã‚„ã‚‹ãªã‚‰æ—¢å­˜ã®ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’è€ƒæ…®ã™ã‚‹ã‹ã‚’ãƒ•ãƒ©ã‚°ã§æ¸¡ã—ã¦é¸ã¹ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```diff ts:ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤ã‚’å«ã‚ã¦ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—åŒ–ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
 export const useParsedQueryValue = <
   Patterns extends readonly AllowParsedQueryValuePattern[]
 >(
   queryKey: string,
   patterns: Patterns
 ) => {
   const [searchParams, setSearchParams] = useSearchParams();
   // çœç•¥

+  const queryStringify = useCallback(
+    (value: MultipleParsedQueryValue<Patterns>) => {
+      const newSearchParams = new URLSearchParams(searchParams);
+
+      let stringifiedValue: string | null = null;
+      for (const pattern of patterns) {
+        if (pattern.type !== value.type) {
+          continue;
+        }
+        if ('stringify' in pattern === false) {
+          stringifiedValue = pattern.type;
+          break;
+        }
+        const str = pattern.stringify(value);
+        stringifiedValue = `${pattern.type}_${str}`;
+        break;
+      }
+
+      if (stringifiedValue != null) {
+        newSearchParams.set(queryKey, stringifiedValue);
+      } else {
+        console.warn('ã‚¯ã‚¨ãƒªã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã—ã¾ã›ã‚“ã§ã—ãŸ:', value);
+        newSearchParams.delete(queryKey);
+      }
+      return newSearchParams.toString();
+    },
+    [queryKey, patterns, searchParams]
+  );

   return {
     // çœç•¥
+    /**
+     * å¯¾è±¡ã®ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤ã‚’å«ã‚ã¦ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—åŒ–ã™ã‚‹
+     * @param value - ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¨ãƒªå€¤
+     */
+    queryStringify,
   };
 };
```

ã“ã‚Œã‚’`useSidePeakValue`ã®returnã«ã‚‚è¿”ã—ã¦ã‚ã’ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff tsx:æ–‡ç« ãƒšãƒ¼ã‚¸ã§useSidePeakValueã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
 export const SentencePage: FC<SentencePageProps> = ({ page: propPage }) => {
   const { page: paramPage } = useParams();

   const page = propPage ?? parsePageNumber(paramPage) ?? 1;
   const sentence = SENTENCES[page - 1];

   const { currentValue } = useSidePeakContextValue();
+  const { queryStringify } = useSidePeakValue();

   return (
     <Box>
       <Typography variant="h6">æ–‡ç« (ãƒšãƒ¼ã‚¸{page})</Typography>
       <Typography>{sentence ?? 'æ–‡ç« ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'}</Typography>
       <Stack sx={{ pt: 1 }} direction="row" justifyContent="space-between">
         {page > 1 ? (
           <Button
             component={NavLink}
             to={
               currentValue != null
-                ? `?sidePeak=sentence&page=${page - 1}`
+                ? '?' + queryStringify({ type: 'sentence', page: page - 1 })
                 : `/sentences/${page - 1}`
             }
           >
             å‰ã¸
           </Button>
          ) : (
            <Box />
          )}
         {page < SENTENCES.length ? (
           <Button
             component={NavLink}
             to={
               currentValue != null
-                ? `?sidePeak=sentence&page=${page + 1}`
+                ? '?' + queryStringify({ type: 'sentence', page: page + 1 })
                 : `/sentences/${page + 1}`
             }
           >
             æ¬¡ã¸
           </Button>
         ) : (
           <Box />
         )}
       </Stack>
     </Box>
   );
 };
```

### ãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ã‚’replaceã§æ›´æ–°ã™ã‚‹

`updateParsedQueryValue`ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®å±¥æ­´ã«è¿½åŠ ã—ã¦æ›´æ–°ã—ã¾ã™ãŒã€replaceã§å·®ã—æ›¿ãˆã¦æ›´æ–°ã—ãŸã„å ´åˆã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚`setSearchParams`ã«ã¯`NavigateOptions`ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã€ãã“ã«`replace?: boolean`ãŒã‚ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã†ã¨å®Ÿç¾ã§ãã¾ã™ã€‚

```diff ts:updateParsedQueryValueã§replacedã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
+import type { NavigateOptions } from 'react-router';
 import { useSearchParams } from 'react-router';

 export const useParsedQueryValue = <
   Patterns extends readonly AllowParsedQueryValuePattern[]
 >(
   queryKey: string,
   patterns: Patterns
 ) => {
   // çœç•¥

   const updateParsedQueryValue = useCallback(
     (
       value: MultipleParsedQueryValue<Patterns> | null,
+      options?: NavigateOptions
     ) => {
       // å®Ÿè£…ã®ä¸­èº«ã¯çœç•¥
+     }, options);
     },
     [queryKey, patterns, setSearchParams]
   );

   return {
     // çœç•¥
   };
 };
```

## çµ‚ã‚ã‚Šã«

ä»¥ä¸ŠãŒä¸€ã¤ã®ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã«è¤‡æ•°ã®æƒ…å ±ã‚’è©°ã‚è¾¼ã‚“ã type safeãªhooksã‚’ä½œã‚‹æ–¹æ³•ã§ã—ãŸã€‚ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³æƒ…å ±ã‹ã‚‰å‹ã‚’ç®—å‡ºã™ã‚‹ã®ãŒçµæ§‹é›£ã—ã„ã¨ã“ã‚ã§ã™ãŒã€ã“ã“ã¾ã§æ±ç”¨çš„ã«ã§ãã‚‹ã¨çµæ§‹è‰²ã€…ãªã¨ã“ã‚ã§å¿œç”¨ãŒåŠ¹ãã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ¼ã‚¹å‘¨ã‚Šã§æ¯å›å®Ÿè£…ã—ã¦ã„ã¦æ‰‹é–“ã ã¨æ€ã£ã¦ã„ã‚‹äººã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
æœ€å¾Œã«æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã«è¼‰ã›ã¾ã™ã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ã”å‚ç…§ãã ã•ã„ã€‚

@[stackblitz](https://stackblitz.com/edit/vitejs-vite-lb86ashr?ctl=1&embed=1&file=src%2Fhooks%2FuseParsedQueryValue.ts)
