---
title: "Rerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½œã‚‹"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react"]
published: true
---

# å§‹ã‚ã«

Reactã§ã¯stateã‚’æ›´æ–°ã™ã‚‹ãŸã³ã«rerenderãŒèµ°ã£ã¦ã—ã¾ã„ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«è‡´å‘½çš„ãªå½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å˜ç´”ãªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ã‚ã£ã¦ã‚‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒrerenderã•ã‚Œã¦ã—ã¾ã„ã€æ•°ãŒè†¨å¤§ã«ãªã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã„ã¾ã™ã€‚

![](/images/supress-rerender/Normal.gif)

rerenderã®å•é¡Œã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹æ–¹æ³•ã¯ãªã„ã‹ã¨è‰²ã€…èª¿ã¹ã¦ã„ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®è¨˜äº‹ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

https://zenn.dev/counterworks/articles/react-hook-form-subscription

ã“ã®ä»•çµ„ã¿ã‚’å‚è€ƒã«ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ©ã‚°ãŒå¤‰ã‚ã‚‹æ™‚ã ã‘rerenderã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«å¿…è¦ãªç®‡æ‰€ã ã‘ã«æŠ‘ãˆã‚‰ã‚Œã¾ã—ãŸã€‚

![](/images/supress-rerender/Memorize.gif)

ä¸Šã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸãŒã€ã„ãã¤ã‹é•ã†ã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ã®ã§ä»Šå›ä½œã£ãŸå†…å®¹ã«ã¤ã„ã¦å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä»Šå›æ¤œè¨¼ã§æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«è²¼ã‚Šã¾ã™ã€‚å‹•ä½œã‚„ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

@[codesandbox](https://codesandbox.io/embed/rerenderwoyi-zhi-surutietukurisutowozuo-ru-xj98ft?fontsize=14&hidenavigation=1&theme=dark)

# Rerenderã‚’é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿

ã¾ãšå§‹ã‚ã«ã€Rerenderã•ã‚ŒãŸã“ã¨ãŒè¦–è¦šçš„ã«åˆ†ã‹ã‚‰ãªã„ã¨å§‹ã¾ã‚Šã¾ã›ã‚“ã€‚è©³ç´°ã¯ä»¥ä¸‹ã®è¨˜äº‹ã«æ›¸ã„ã¦ã„ã¾ã™ãŒã€ã“ã¡ã‚‰ã§ã‚‚ã‚³ãƒ¼ãƒ‰ã¯è¼‰ã›ã¦ãŠãã¾ã™ã€‚

https://zenn.dev/numa_san/articles/a90f20b92112aa#web-animations-api%E3%81%A7%E5%AE%9F%E8%A3%85

```tsx:NotifyRerender.tsx
import { FC, useRef, useEffect } from "react";

export const NotifyRerender: FC = () => {
  const elRootRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    if (elRootRef.current == null) {
      return;
    }

    elRootRef.current.animate([{ opacity: 1 }, { opacity: 0 }], {
      duration: 500,
      fill: "forwards"
    });
  });

  return (
    <div ref={elRootRef} style={{ color: "red" }}>
      Rerender
    </div>
  );
};
```

ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é…ç½®ã™ã‚‹ã ã‘ã§rerenderã™ã‚‹ãŸã³ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®éš£ã«æ¯å›å®Ÿè£…ã™ã‚‹ã®ã¯å¤§å¤‰ãªã®ã§ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚»ãƒƒãƒˆã«ã—ãŸãƒã‚§ãƒƒã‚¯ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œã‚Šã¾ã—ãŸã€‚ã¤ã„ã§ã«ä»Šå›ã¯ãƒã‚§ãƒƒã‚¯ã¨ã‚¢ãƒ³ãƒã‚§ãƒƒã‚¯ã®ä¸­é–“ã¨ãªã‚‹`indeterminate`ã®çŠ¶æ…‹ã‚‚ã‚ã‚‹ã®ã§ã€ãã‚Œã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã¡ãªã¿ã«`indeterminate`ã¯DOMã‚’ç›´æ¥æ“ä½œã™ã‚‹ã—ã‹å…¥ã‚Œã‚‰ã‚Œãªã‹ã£ãŸã®ã§ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«useEffectã§å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

https://www.robinwieruch.de/react-checkbox-indeterminate/

```tsx:InputCheck.tsx
import { FC, useRef, useEffect } from "react";

import { NotifyRerender } from "./NotifyRerender";

export type InputCheckProps = {
  isChecked: boolean;
  label: string;
  indeterminate?: boolean;
  onChangeIsChecked: (newIsChecked: boolean) => void;
};

export const InputCheck: FC<InputCheckProps> = ({
  isChecked,
  label,
  indeterminate,
  onChangeIsChecked
}) => {
  const elInputRef = useRef<HTMLInputElement | null>(null);

  useEffect(() => {
    if (elInputRef.current == null) {
      return;
    }

    elInputRef.current.indeterminate = indeterminate === true;
  }, [indeterminate]);

  return (
    <label
      style={{
        display: "inline-flex",
        padding: "5px",
        border: "solid 1px #ccc",
        borderRadius: "5px",
        cursor: "pointer"
      }}
    >
      <input
        ref={elInputRef}
        type="checkbox"
        checked={isChecked}
        readOnly
        onChange={() => {
          onChangeIsChecked(!isChecked);
        }}
      />
      <span style={{ marginRight: "4px" }}>{label}</span>
      <NotifyRerender />
    </label>
  );
};
```

ã“ã‚Œã§ã“ã®éƒ¨åˆ†ãŒã§ãã¾ã—ãŸã€‚

![](/images/supress-rerender/InputCheck.png)

# ä»Šå›ä½œã£ãŸãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ§‹æˆ

ä»Šå›ã®ãƒã‚§ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿æ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚‚ã®ã§ä½œã‚Šã¾ã™ã€‚

```ts:ã‚°ãƒ«ãƒ¼ãƒ—é …ç›®
export type Item = {
  id: number;
};

export type GroupItem = {
  label: string;
  items: Item[];
};

export const GROUP_ITEMS: GroupItem[] = [
  {
    label: "ã‚°ãƒ«ãƒ¼ãƒ—ï¼‘",
    items: [{ id: 1 }, { id: 2 }, { id: 3 }]
  },
  {
    label: "ã‚°ãƒ«ãƒ¼ãƒ—ï¼’",
    items: [{ id: 11 }, { id: 12 }, { id: 13 }]
  }
];
```

ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸé …ç›®ã¯idãƒªã‚¹ãƒˆã ã‘stateã§ä¿æŒã—ã¾ã™ã€‚å„é …ç›®ãŒã“ã®idãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã‚’è¡¨ç¤ºã™ã‚‹æ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

```ts
const [checkedItemIds, setCheckedItemIds] = useState<number[]>([]);
```

# Rerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ä»•çµ„ã¿ã‚’ä½œã‚‹

## å‰æ

ä»Šå›ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´ã§ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯é€šå¸¸ã®å®Ÿè£…ã¨å…¨ãåŒã˜æ›¸ãæ–¹ãŒã§ãã‚‹çŠ¶æ…‹ã«ã™ã‚‹ãŸã‚ã€`react-hook-form`ã¨ã¯é•ã„ã€ãƒã‚§ãƒƒã‚¯ãŒå¤‰æ›´ã™ã‚‹åº¦ã«è¦ªã«ã¯å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãŒé€ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```tsx:é€šå¸¸ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‘¼ã³å‡ºã—
<NormalCheckList
  groupItems={GROUP_ITEMS}
  checkedItemIds={checkedItemIds}
  onChangeCheckedItemIds={(newCheckedItemIds) => {
    setCheckedItemIds(newCheckedItemIds);
  }}
/>
```

```tsx:Contextã‚’ä½¿ã£ãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´ç‰ˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‘¼ã³å‡ºã—
<ContextCheckGroupList
  groupItems={GROUP_ITEMS}
  checkedItemIds={checkedItemIds}
  onChangeCheckedItemIds={(newCheckedItemIds) => {
    setCheckedItemIds(newCheckedItemIds);
  }}
/>
```

ã—ãŸãŒã£ã¦ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯æ¯å›rerenderã•ã‚Œã¦ã„ã¾ã™ãŒã€ãã®çŠ¶æ…‹ã§ã‚ã£ã¦ã‚‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚memoåŒ–ã—ã¦ãŠãã“ã¨ã§å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¿…è¦æœ€ä½é™ã®éƒ¨åˆ†ã ã‘rerenderã•ã‚Œã‚‹ã‚ˆã†èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚

## ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹Contextã‚’ä½œã‚‹

ã¾ãšã¯ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’Contextã«åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚ContextçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒã§ãã‚‹ã¨rerenderå¯¾è±¡ã¨ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯`useContext`ã—ãŸã‚‚ã®ã ã‘ã«æŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚æ›´ã«Providerã«æµã™valueã‚’ã—ã£ã‹ã‚ŠmemoåŒ–ã—ã¦ãŠãã“ã¨ã§`useContext`ã‚’å‘¼ã‚“ã§ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚rerenderã•ã‚Œãªããªã‚Šã¾ã™ã€‚

```tsx:ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹Contextã®åœŸå°ã‚’ä½œã‚‹
import {
  FC,
  PropsWithChildren,
  createContext,
  useRef,
  useCallback,
  useContext,
  useMemo,
  useEffect
} from "react";
import { uniq } from "lodash-es";

type CheckManagementContextValue = {
  /**
   * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
   */
  getCheckValues: () => number[];
  /**
   * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹
   * @param values - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®å€¤ãƒªã‚¹ãƒˆ
   */
  addCheckValues: (values: number[]) => void;
  /**
   * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰å–ã‚Šé™¤ã
   * @param values - é™¤å¤–ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®å€¤ãƒªã‚¹ãƒˆ
   */
  removeCheckValues: (values: number[]) => void;
};

export type CheckManagementProviderProps = PropsWithChildren<{
  /** ãƒã‚§ãƒƒã‚¯ã—ãŸå€¤ãƒªã‚¹ãƒˆ */
  checkValues: number[];
  /**
   * ãƒã‚§ãƒƒã‚¯ã—ãŸå€¤ãƒªã‚¹ãƒˆãŒå¤‰æ›´ã™ã‚‹æ™‚
   * @param newCheckValues - æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ã—ãŸå€¤ãƒªã‚¹ãƒˆ
   */
  onChangeCheckValues: (newCheckValues: number[]) => void;
}>;

const CheckManagementContext = createContext<
  CheckManagementContextValue | undefined
>(undefined);

export const CheckManagementProvider: FC<CheckManagementProviderProps> = ({
  checkValues,
  onChangeCheckValues,
  children
}) => {
  // depså¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹ãŸã‚ã«refã«é€€é¿ã™ã‚‹
  const checkValuesRef = useRef(checkValues);
  const onChangeCheckValuesRef = useRef(onChangeCheckValues);

  const getCheckValues: CheckManagementContextValue["getCheckValues"] = useCallback(() => {
    return checkValuesRef.current;
  }, []);

  const addCheckValues: CheckManagementContextValue["addCheckValues"] = useCallback(
    (values) => {
      const currentCheckValues = checkValuesRef.current;
      onChangeCheckValuesRef.current(uniq([...currentCheckValues, ...values]));
    },
    []
  );

  const removeCheckValues: CheckManagementContextValue["removeCheckValues"] = useCallback(
    (values) => {
      const currentCheckValues = checkValuesRef.current;
      onChangeCheckValuesRef.current(
        currentCheckValues.filter((val) => !values.includes(val))
      );
    },
    []
  );

  useEffect(() => {
    checkValuesRef.current = checkValues;
  }, [checkValues]);

  useEffect(() => {
    onChangeCheckValuesRef.current = onChangeCheckValues;
  }, [onChangeCheckValues]);

  // useContextã—ãŸã‚‚ã®ãŒæ¯å›rerenderã•ã‚Œãªã„ã‚ˆã†ã«ãƒ¡ãƒ¢åŒ–ã—ãŸã‚‚ã®ã‚’Providerã«æµã™
  const contextValue = useMemo<CheckManagementContextValue>(
    () => ({
      getCheckValues,
      addCheckValues,
      removeCheckValues
    }),
    [
      getCheckValues,
      addCheckValues,
      removeCheckValues
    ]
  );

  return (
    <CheckManagementContext.Provider value={contextValue}>
      {children}
    </CheckManagementContext.Provider>
  );
};

export const useCheckManagementContextValue = () => {
  const contextValue = useContext(CheckManagementContext);
  if (contextValue == null) {
    throw new Error("CheckManagementProviderãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
  }
  return contextValue;
};
```

ã“ã‚Œã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒˆã«é…ç½®ã—ã€ã“ã‚Œã‚ˆã‚Šã‚‚é…ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã©ã“ã§ã‚‚Contextã®å€¤ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã€ã‹ã¤æœ€æ–°ã®ãƒã‚§ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚„æ›´æ–°ã™ã‚‹éš›ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ProviderçµŒç”±ã§è¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹Contextã‚’ä½¿ç”¨ã™ã‚‹
export type ContextCheckGroupListProps = {
  /** é¸æŠã—ãŸé …ç›®IDãƒªã‚¹ãƒˆ */
  checkedItemIds: number[];
  /** é …ç›®ãƒªã‚¹ãƒˆ */
  groupItems: GroupItem[];
  /**
   * é¸æŠã—ãŸé …ç›®ãƒªã‚¹ãƒˆã‚’å¤‰ãˆã‚‹å ´åˆ
   * @param newCheckedItemIds - é¸æŠã—ãŸé …ç›®IDãƒªã‚¹ãƒˆ
   */
  onChangeCheckedItemIds: (newCheckedItemIds: number[]) => void;
};

export const ContextCheckGroupList: FC<ContextCheckGroupListProps> = ({
  checkedItemIds,
  groupItems,
  onChangeCheckedItemIds
}) => {
  return (
    <CheckManagementProvider
      checkValues={checkedItemIds}
      onChangeCheckValues={onChangeCheckedItemIds}
    >
      {/* è©³ç´°ã®å®Ÿè£… */}
    </CheckManagementProvider>
  );
};
```

## ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç›£è¦–ã™ã‚‹hooksã‚’ä½œã‚‹

ã“ã‚Œã§å®Œå…¨ã«rerenderã‚’æŠ‘åˆ¶ã—ãŸContextãŒä½œã‚Œã¾ã—ãŸãŒã€ã“ã®ã¾ã¾ã ã¨å€¤ãŒå¤‰ã‚ã£ã¦ã‚‚rerenderã•ã‚Œã¾ã›ã‚“ã€‚ã“ã®å•é¡Œã¯æœ€åˆã«ç´¹ä»‹ã—ãŸè¨˜äº‹ã«ã‚‚ã‚ã‚‹ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã§å¯¾å¿œã—ã¾ã™ã€‚ãŸã ä»Šå›ã¯ãã“ã¾ã§å¤§è¢ˆè£Ÿãªã‚‚ã®ã¯ä½œã‚‰ãšã«ã€å˜ç´”ã«å¤‰æ›´ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«`addListener`ã¨`removeListener`ã‚’ç”¨æ„ã—ã¦åŒç­‰ã®ã‚‚ã®ã‚’ä½œã‚Šã¾ã™ã€‚

```diff tsx:Contextã«addListenerã¨removeListenerã‚’æä¾›ã™ã‚‹
+/**
+ * ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
+ * @param newCheckValues - ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
+ */
+type OnChangeCheckValuesListener = (newCheckValues: number[]) => void;

 type CheckManagementContextValue = {
   /**
    * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
    */
   getCheckValues: () => number[];
   /**
    * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹
    * @param values - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®å€¤ãƒªã‚¹ãƒˆ
    */
   addCheckValues: (values: number[]) => void;
   /**
    * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰å–ã‚Šé™¤ã
    * @param values - é™¤å¤–ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®å€¤ãƒªã‚¹ãƒˆ
    */
   removeCheckValues: (values: number[]) => void;
+  /**
+   * ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹
+   * @param listener - ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
+   */
+  addListener: (listener: OnChangeCheckValuesListener) => void;
+  /**
+   * ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®å¤‰æ›´ã®è³¼èª­ã‚’ã‚„ã‚ã‚‹
+   * @param listener - ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
+   */
+  removeListener: (listener: OnChangeCheckValuesListener) => void;
 };

 export const CheckManagementProvider: FC<CheckManagementProviderProps> = ({
   checkValues,
   onChangeCheckValues,
   children
 }) => {
   // depså¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹ãŸã‚ã«refã«é€€é¿ã™ã‚‹
   const checkValuesRef = useRef(checkValues);
   const onChangeCheckValuesRef = useRef(onChangeCheckValues);

+  const listenersRef = useRef<OnChangeCheckValuesListener[]>([]);

   // getCheckValue, addCheckValues, removeCheckValuesã®å®šç¾©ã¯æ—¢å‡ºãªã®ã§çœç•¥

+  const addListener: CheckManagementContextValue["addListener"] = useCallback(
+    (listener) => {
+      listenersRef.current.push(listener);
+    },
+    []
+  );

+  const removeListener: CheckManagementContextValue["removeListener"] = useCallback(
+    (listener) => {
+      listenersRef.current = listenersRef.current.filter(
+        (lis) => lis !== listener
+      );
+    },
+    []
+  );

   useEffect(() => {
     checkValuesRef.current = checkValues;

+    listenersRef.current.forEach((listener) => {
+      listener(checkValues);
+    });
   }, [checkValues]);

   useEffect(() => {
     onChangeCheckValuesRef.current = onChangeCheckValues;
   }, [onChangeCheckValues]);

   const contextValue = useMemo<CheckManagementContextValue>(
     () => ({
       getCheckValues,
       addCheckValues,
       removeCheckValues,
+      addListener,
+      removeListener
     }),
     [
       getCheckValues,
       addCheckValues,
       removeCheckValues,
+      addListener,
+      removeListener
     ]
   );

   return (
     <CheckManagementContext.Provider value={contextValue}>
       {children}
     </CheckManagementContext.Provider>
   );
 };
```

å¤‰æ›´æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€ã“ã‚Œã‚’ä½¿ã£ã¦ãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰æ›´ã§ãã‚‹hooksã‚’ç”¨æ„ã—ã¾ã™ã€‚ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«`boolean`ã ã‘ã§ãªã`indeterminate`ã¨ã„ã†ãƒªãƒ†ãƒ©ãƒ«ã‚‚è¿”ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```ts:ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¯¾å¿œã—ãŸãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™hooks
/**
 * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¯¾å¿œã—ãŸãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™hooks
 * @param callback - å¤‰æ›´æ™‚ã«ç®—å‡ºã™ã‚‹ãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™ãƒãƒ³ãƒ‰ãƒ©
 */
export const useWatchCheckStatus = (
  callback: (newCheckValues: number[]) => boolean | "indeterminate"
) => {
  const {
    getCheckValues,
    addListener,
    removeListener
  } = useCheckManagementContextValue();

  const [checkStatus, setCheckStatus] = useState(() => {
    const checkValues = getCheckValues();
    return callback(checkValues);
  });

  useEffect(() => {
    const listener = (newCheckValues: number[]) => {
      const newCheckStatus = callback(newCheckValues);
      setCheckStatus(newCheckStatus);
    };

    addListener(listener);

    return () => {
      removeListener(listener);
    };
  }, [callback, addListener, removeListener]);

  return checkStatus;
};
```

`listener`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§seté–¢æ•°ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŸã‚ã€å¤‰æ›´ãŒã‚ã‚‹å ´åˆrerenderãŒèµ°ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«å…¨ãåŒã˜å€¤ã®å ´åˆã¯seté–¢æ•°ã‚’å‘¼ã‚“ã§ã‚‚rerenderã¯ã•ã‚Œãªã„ã®ã§ã€ä¾‹ãˆã°æ—¢ã«`true`ã«ãªã£ã¦ã„ã‚‹çŠ¶æ…‹ã§æ”¹ã‚ã¦`true`ã‚’setã—ã¦ã‚‚rerenderã¯ã•ã‚Œã¾ã›ã‚“ã€‚

## ContextçµŒç”±ã§ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’å–å¾—ãƒ»æ›´æ–°ã™ã‚‹

ã‚ã¨ã¯ã“ã‚Œã‚‰ã‚’ä½¿ã£ã¦ã€å˜ä¸€ã®ãƒã‚§ãƒƒã‚¯ã¨ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãã‚Œãã‚Œã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```tsx:å˜ä¸€ã®ãƒã‚§ãƒƒã‚¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
import { FC, memo } from "react";

export type ContextCheckForSingleProps = {
  /** é …ç›® */
  item: Item;
};

export const ContextCheckForSingle: FC<ContextCheckForSingleProps> = memo(
  ({ item }) => {
    const {
      addCheckValues,
      removeCheckValues
    } = useCheckManagementContextValue();
    const checkStatus = useWatchCheckStatus((checkValues) =>
      checkValues.includes(item.id)
    );
    return (
      <InputCheck
        label={JSON.stringify(item)}
        isChecked={checkStatus === true}
        onChangeIsChecked={(newIsChecked) => {
          if (newIsChecked) {
            addCheckValues([item.id]);
          } else {
            removeCheckValues([item.id]);
          }
        }}
      />
    );
  }
);
```

```tsx:ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
import { FC, memo } from "react";

export type ContextCheckForGroupProps = {
  /** ã‚°ãƒ«ãƒ¼ãƒ—é …ç›® */
  groupItem: GroupItem;
};

export const ContextCheckForGroup: FC<ContextCheckForGroupProps> = memo(
  ({ groupItem }) => {
    const allItemIds = groupItem.items.map((item) => item.id);

    const {
      addCheckValues,
      removeCheckValues
    } = useCheckManagementContextValue();
    const checkStatus = useWatchCheckStatus((checkValues) => {
      const isAllChecked = allItemIds.every((id) => checkValues.includes(id));
      const isAnyChecked = allItemIds.some((id) => checkValues.includes(id));

      return isAllChecked ? true : isAnyChecked ? "indeterminate" : false;
    });

    return (
      <InputCheck
        label="ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ãƒˆã‚°ãƒ«"
        isChecked={checkStatus === true}
        indeterminate={checkStatus === "indeterminate"}
        onChangeIsChecked={(newIsChecked) => {
          if (newIsChecked) {
            addCheckValues(allItemIds);
          } else {
            removeCheckValues(allItemIds);
          }
        }}
      />
    );
  }
);
```

# çµ‚ã‚ã‚Šã«

ä»¥ä¸ŠãŒrerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½œã‚‹æ–¹æ³•ã§ã—ãŸã€‚å®Ÿè£…ã¯ãã‚Œãªã‚Šã«é›£ã—ã‹ã£ãŸã§ã™ãŒã€ä»–ã§ã‚‚å¿œç”¨ã§ãã‚‹è¨­è¨ˆæ–¹æ³•ã ã¨æ€ã„ã¾ã™ã®ã§ã€rerenderã‚’æœ€å°é™ã«æŠ‘ãˆãŸã„æ™‚ã®å‚è€ƒã«ãªã‚Œã‚Œã°å¹¸ã„ã§ã™ã€‚
