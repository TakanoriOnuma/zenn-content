---
title: "Rerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹æ±ç”¨çš„ãªå€¤ç›£è¦–Providerã‚’ä½œã£ãŸ"
emoji: "ğŸª­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react"]
published: true
---

## å§‹ã‚ã«

ä»¥å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®å®Ÿè£…ã§rerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ãŸã‚ã«subscribeå½¢å¼ã§hookså†…ã§å€¤ãŒå¤‰ã‚ã£ãŸæ™‚ã®ã¿å‘¼ã³å‡ºã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘rerenderã•ã‚Œã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã—ãŸã€‚

https://zenn.dev/numa_san/articles/0ead8cd9465a22

ã“ã®æ–¹æ³•ã‚’å¿œç”¨ã™ã‚Œã°ã©ã®ã‚±ãƒ¼ã‚¹ã§ã‚‚ã‚ã‚‹ç¨‹åº¦é©ç”¨ã§ãã¾ã™ãŒã€æ¯å›ã“ã®ä»•çµ„ã¿ã‚’ä½œã‚‹ã®ã¯æ‰‹é–“ãªã®ã¨å¯èª­æ€§ãŒå°‘ã—è½ã¡ã‚‹ã®ãŒãƒãƒƒã‚¯ã§ã—ãŸã€‚ãã“ã§ã‚ˆã‚Šæ±ç”¨çš„ãªã‚‚ã®ã‚’ä½œã£ã¦ã€ãã‚Œãƒ™ãƒ¼ã‚¹ã§å€‹åˆ¥ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚Œã‚‹ã‚ˆã†ãªã‚‚ã®ã‚’ä½œã‚Šã¾ã—ãŸã€‚

## æ±ç”¨çš„ãªå€¤ç›£è¦–Providerã®å®Ÿè£…

rerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ãŸã‚ã®ã‚³ã‚¢ã®ä»•çµ„ã¿ã¯ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå€¤ã¯å®Œå…¨ã«ãƒ¡ãƒ¢åŒ–ã—ã¦å¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ã€å€¤ã®å¤‰æ›´ã¯ãƒªã‚¹ãƒŠãƒ¼çµŒç”±ã®ã¿ã§è¡Œã†ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ã“ã‚Œã«åˆã£ãŸåå‰ã¨ã—ã¦Providerã¯`ObserverProvider`ã¨ã„ã†åå‰ã«ã—ã€`useSubscribe`ã¨ã„ã†hooksã§å€¤ã‚’å–å¾—ã™ã‚‹ã¨ã„ã†æ–¹é‡ã«ã—ã¾ã—ãŸã€‚Providerã«æ¸¡ã™ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå€¤ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

```ts:Observer Providerã«æ¸¡ã™ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå€¤ã®å‹
import type { SetStateAction, Dispatch } from 'react';

/**
 * ç›£è¦–å¯¾è±¡ã®å€¤ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
 * @param newValue - ç›£è¦–å¯¾è±¡å€¤
 */
export type OnChangeObservedValueListener<T> = (newValue: T) => void;

/** ç›£è¦–ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå€¤ */
export type ObserverContextValue<T> = {
  /**
   * ç›£è¦–å¯¾è±¡ã®å€¤ã‚’å–å¾—ã™ã‚‹
   */
  getObservedValue: () => T;
  /**
   * ç›£è¦–å¯¾è±¡ã®å€¤ã‚’æ›´æ–°ã™ã‚‹
   */
  updateObservedValue: Dispatch<SetStateAction<T>>;
  /**
   * ç›£è¦–å¯¾è±¡ã®å€¤ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹
   * @param listener - ç›£è¦–å¯¾è±¡ã®å€¤ã®å¤‰æ›´ã‚’è³¼èª­ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
   */
  addListener: (listener: OnChangeObservedValueListener<T>) => void;
  /**
   * ç›£è¦–å¯¾è±¡ã®å€¤ã®å¤‰æ›´ã®è³¼èª­ã‚’ã‚„ã‚ã‚‹
   * @param listener - ç›£è¦–å¯¾è±¡ã®å€¤ã®å¤‰æ›´ã‚’è³¼èª­ã—ã¦ã„ã‚‹ãƒªã‚¹ãƒŠãƒ¼
   */
  removeListener: (listener: OnChangeObservedValueListener<T>) => void;
};
```

å®šç¾©ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åˆã†ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦ã„ãã¾ã™ãŒã€ãƒªã‚¹ãƒŠãƒ¼ã®ç®¡ç†éƒ¨åˆ†ã¯hooksã§åˆ‡ã‚Šå‡ºã—ã¦ãŠãã¨è¦‹é€šã—ãŒè‰¯ããªã‚‹ã®ã§å…ˆã«ãã‚Œã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```ts:ç›£è¦–å¯¾è±¡ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ç®¡ç†ã™ã‚‹hooks
const useObserverListeners = function <T>() {
  const listenersRef = useRef<OnChangeObservedValueListener<T>[]>([]);
  const addListener: ObserverContextValue<T>['addListener'] = useCallback(
    (listener) => {
      listenersRef.current.push(listener);
    },
    []
  );
  const removeListener: ObserverContextValue<T>['removeListener'] = useCallback(
    (listener) => {
      listenersRef.current = listenersRef.current.filter(
        (lis) => lis !== listener
      );
    },
    []
  );
  const broadcast = useCallback((value: T) => {
    listenersRef.current.forEach((listener) => {
      listener(value);
    });
  }, []);

  return {
    addListener,
    removeListener,
    /** å€¤ã‚’å…¨ãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥ã™ã‚‹ */
    broadcast,
  };
};
```

ã“ã®hooksã‚‚ä½¿ã£ã¦Providerã‚’å®Ÿè£…ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚æ±ç”¨çš„ãªProviderãªã®ã§ä½•å€‹ã§ã‚‚ä½œã‚Œã‚‹ã‚ˆã†ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’é€šã—ã¦Providerã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```tsx:ObserverProviderã‚’ä½œã‚‹é–¢æ•°
import type { SetStateAction, FC, PropsWithChildren, Context } from 'react';
import {
  useCallback,
  useRef,
  useEffect,
  useMemo,
} from 'react';

export type ObserverProviderProps<T> = PropsWithChildren<{
  /** ç›£è¦–å¯¾è±¡ã®å€¤ */
  value: T;
  /**
   * ç›£è¦–å¯¾è±¡ã®å€¤ãŒå¤‰æ›´ã—ãŸã¨ã
   * @param newValue - æœ€æ–°ã®ç›£è¦–å¯¾è±¡ã®å€¤
   */
  onChangeValue: (newValue: T) => void;
}>;

/**
 * updaterãŒãƒ¡ã‚½ãƒƒãƒ‰ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 */
 function checkIsUpdaterFn<S>(
  updater: SetStateAction<S>
): updater is (prev: S) => S {
  return typeof updater === 'function';
}

export const createObserverProvider = function <T>(
  ObserverContext: Context<ObserverContextValue<T> | undefined>
) {
  const ObserverProvider: FC<ControlledObserverProviderProps<T>> = ({
    value,
    onChangeValue,
    children
  }) => {
    // depså¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹ãŸã‚ã«refã«é€€é¿ã™ã‚‹
    const observedValueRef = useRef(value);
    observedValueRef.current = value;
    const onChangeValueRef = useRef(onChangeValue);
    onChangeValueRef.current = onChangeValue;

    const getObservedValue: ObserverContextValue<T>['getObservedValue'] =
      useCallback(() => {
        return observedValueRef.current;
      }, []);

    const updateObservedValue: ObserverContextValue<T>['updateObservedValue'] =
      useCallback((updater) => {
        const newValue = checkIsUpdaterFn(updater)
          ? updater(observedValueRef.current)
          : updater;
        onChangeValueRef.current(newValue);
      }, []);

    const { addListener, removeListener, broadcast } =
      useObserverListeners<T>();
    useEffect(() => {
      broadcast(value);
    }, [broadcast, value]);

    const contextValue = useMemo<ObserverContextValue<T>>(() => {
      return {
        getObservedValue,
        updateObservedValue,
        addListener,
        removeListener,
      };
    }, [getObservedValue, updateObservedValue, addListener, removeListener]);

    return (
      <ObserverContext.Provider value={contextValue}>
        {children}
      </ObserverContext.Provider>
    );
  }

  return ObserverProvider;
};
```

å¾Œã¯ã“ã‚Œã¨ã‚»ãƒƒãƒˆã§`useObserve`ãªã©ã®hooksã‚‚å®šç¾©ã—ã¦ä¸€ç·’ã«è¿”ã™ã‚ˆã†ã«ã—ãŸã‚‰å®Œæˆã§ã™ã€‚

```tsx:æ±ç”¨å€¤ç›£è¦–ã®Contextã‚„Providerãªã©ä¸€å¼ã‚’è¿”ã™
import { useState, createContext, useEffect, useContext } from 'react';
import type { ComponentType, FC } from 'react';

import type { ObserverContextValue } from './ObserverContextValue';
import { createObserverProvider } from './createObserverProvider';

/**
 * å¯¾è±¡ã®å€¤ã‚’ç›£è¦–ã—ã¦å¤‰æ›´æ™‚ã®ã¿rerenderã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹Contextã‚„Providerãªã©ä¸€å¼ã‚’è¿”ã™
 */
export const createObserverContextKit = function <T>({
  notProvidedErrorMessage = 'ObserverProviderãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
}: {
  notProvidedErrorMessage?: string;
} = {}) {
  const ObserverContext = createContext<ObserverContextValue<T> | undefined>(
    undefined
  );

  const ObserverProvider = createObserverProvider(ObserverContext);

  const useObserverContextValue = () => {
    const contextValue = useContext(ObserverContext);
    if (contextValue == null) {
      throw new Error(notProvidedErrorMessage);
    }
    return contextValue;
  };

  const useObserve = function <U>(callback: (observedValue: T) => U) {
    const { getObservedValue, addListener, removeListener } =
      useObserverContextValue();

    const [result, setResult] = useState(() => {
      const observedValue = getObservedValue();
      return callback(observedValue);
    });

    useEffect(() => {
      const listener = (observedValue: T) => {
        const result = callback(observedValue);
        setResult(result);
      };

      addListener(listener);
      listener(getObservedValue());

      return () => {
        removeListener(listener);
      };
    }, [callback, addListener, removeListener]);

    return result;
  };

  return {
    ObserverProvider,
    withUncontrolledObserverProvider,
    useObserverContextValue,
    useObserve,
  };
};
```

### ä½¿ç”¨ä¾‹: ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ç®¡ç†

`createObserverContextKit`ã‚’ä½¿ã£ã¦ã€å†’é ­ã§è©±ã—ãŸãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ç®¡ç†ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚æ±ç”¨çš„ãªå‘½åãªã®ã§åŸºæœ¬çš„ã«ã¯æ”¹ã‚ã¦ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã£ãŸProviderã‚„hooksã‚’å®šç¾©ã—ã¦ãã®ä¸­ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚ç‰¹ã«`updateObservedValue`ã¯å€¤ã‚’è‡ªç”±ã«å¤‰æ›´ã§ãã¦ã—ã¾ã†ã®ã§ç”¨é€”ã‚’é™å®šã—ãŸhooksã‚’è¿”ã—ã¦å†…éƒ¨ã ã‘ä½¿ã†ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§å½±éŸ¿ç¯„å›²ã‚’åˆ¶é™ã§ãã¾ã™ã€‚

```tsx:createObserverContextKitã‚’ä½¿ã£ã¦ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ç®¡ç†Providerã‚’å®Ÿè£…ã™ã‚‹
import type { FC, PropsWithChildren } from 'react';
import { useCallback } from 'react';
import { uniq } from 'es-toolkit';

import { createObserverContextKit } from './createObserverContextKit';

const { ObserverProvider, useObserverContextValue, useObserve } =
  createObserverContextKit<number[]>({
    notProvidedErrorMessage: 'CheckManagementProviderãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
  });

export type CheckManagementProviderProps = PropsWithChildren<{
  /** ãƒã‚§ãƒƒã‚¯ã—ãŸå€¤ãƒªã‚¹ãƒˆ */
  checkValues: number[];
  /**
   * ãƒã‚§ãƒƒã‚¯ã—ãŸå€¤ãƒªã‚¹ãƒˆãŒå¤‰æ›´ã™ã‚‹æ™‚
   * @param newCheckValues - æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ã—ãŸå€¤ãƒªã‚¹ãƒˆ
   */
  onChangeCheckValues: (newCheckValues: number[]) => void;
}>;

/**
 * ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹Provider
 */
export const CheckManagementProvider: FC<CheckManagementProviderProps> = ({
  checkValues,
  onChangeCheckValues,
  children,
}) => {
  return (
    <ObserverProvider value={checkValues} onChangeValue={onChangeCheckValues}>
      {children}
    </ObserverProvider>
  );
};

/**
 * ãƒã‚§ãƒƒã‚¯å€¤ã‚’å¤‰æ›´ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ã‚»ãƒƒãƒˆã‚’è¿”ã™hooks
 */
export const useChangeCheckValuesHandler = () => {
  const { updateObservedValue } = useObserverContextValue();

  const addCheckValues = useCallback(
    (values: number[]) => {
      updateObservedValue((currentValues) => {
        return uniq([...currentValues, ...values]);
      });
    },
    [updateObservedValue]
  );

  const removeCheckValues = useCallback(
    (values: number[]) => {
      updateObservedValue((currentValues) => {
        return currentValues.filter((val) => !values.includes(val));
      });
    },
    [updateObservedValue]
  );

  return {
    addCheckValues,
    removeCheckValues,
  };
};

/**
 * ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¯¾å¿œã—ãŸãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™hooks
 * @param callback - å¤‰æ›´æ™‚ã«ç®—å‡ºã™ã‚‹ãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™ãƒãƒ³ãƒ‰ãƒ©
 */
export const useWatchCheckStatus = (
  callback: (newCheckValues: number[]) => boolean | 'indeterminate'
) => {
  const checkStatus = useObserve(callback);
  return checkStatus;
};
```

## å€¤ã¯å†…éƒ¨ã§ç®¡ç†ã—ã¦å³æ™‚åæ˜ ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ 

ä»¥ä¸ŠãŒåŸºæœ¬çš„ãªå®Ÿè£…ã§ã™ãŒã€ä¸€ã¤ã ã‘æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚`useObserverListeners`ã®`broadcast`ã§ãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥ã—ã¦ã„ã¾ã™ãŒã€ã“ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ`useEffect`ã§å€¤å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸæ™‚ã«ãªã‚‹ãŸã‚ãƒ¯ãƒ³ã‚µã‚¤ã‚¯ãƒ«é…ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šä¸€ç¬ã ã‘è¦ªã§å¤‰ã‚ã£ãŸå€¤ã¨å­ã«åæ˜ ã•ã‚ŒãŸå€¤ã«ã‚ºãƒ¬ãŒç™ºç”Ÿã—ã¾ã™ã€‚ä¸€ç¬ãªã®ã§ã»ã¨ã‚“ã©ã®ã‚±ãƒ¼ã‚¹ã§ã¯æ°—ã«ã—ãªãã¦è‰¯ã„ã¨æ€ã„ã¾ã™ãŒã€ä¾‹ãˆã°ç”»é¢å¹…ã«ã‚ˆã£ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤§ããå¤‰ãˆã‚‹ã¨ã‹ã‚’ã™ã‚‹ã¨ãƒãƒ©ã¤ããŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®å•é¡Œã‚’å›é¿ã™ã‚‹ã«ã¯è¦ªã§ç®¡ç†ã™ã‚‹ã®ã‚’è¾ã‚ã¦å†…éƒ¨ã§ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚å†…éƒ¨ã§ç®¡ç†ã™ã‚‹ã“ã¨ã§ä¸€åº¦è¦ªã«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹å¿…è¦ãŒãªããªã‚Šã€å³æ™‚ã§ãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
å†…éƒ¨ã§ç®¡ç†ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰æ›´ã¯Provideréƒ¨åˆ†ã ã‘å¤‰ãˆã‚Œã°è‰¯ã„ã®ã§ã€`createObserverProvider`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰ãˆã¦Uncontrolledãƒ‘ã‚¿ãƒ¼ãƒ³ã®Providerã‚‚å®Ÿè£…ã—ã¦æ¡ä»¶åˆ†å²ã—ã¦å‘¼ã³å‡ºã—ã¾ã™ã€‚

```diff tsx:Uncontrolledãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚å¯¾å¿œã™ã‚‹
 /** ç›£è¦–ã™ã‚‹å€¤ã‚’å¤–ã‹ã‚‰æ¸¡ã—ã¦ç®¡ç†ã™ã‚‹Provider */
 type ControlledObserverProviderProps<T> = PropsWithChildren<{
   /** ç›£è¦–å¯¾è±¡ã®å€¤ */
   value: T;
   /**
    * ç›£è¦–å¯¾è±¡ã®å€¤ãŒå¤‰æ›´ã—ãŸã¨ã
    * @param newValue - æœ€æ–°ã®ç›£è¦–å¯¾è±¡ã®å€¤
    */
   onChangeValue: (newValue: T) => void;
 }>;

+/** ç›£è¦–ã™ã‚‹å€¤ã‚’å†…éƒ¨ã§ç®¡ç†ã™ã‚‹Provider */
+type UncontrolledObserverProviderProps<T> = PropsWithChildren<{
+  /** ç›£è¦–å¯¾è±¡ã®åˆæœŸå€¤ */
+  initialValue: T;
+}>

+export type ObserverProviderProps<T> = ControlledObserverProviderProps<T> | UncontrolledObserverProviderProps<T>

export const createObserverProvider = function <T>(
  ObserverContext: Context<ObserverContextValue<T> | undefined>
) {
   // ControlledObserverã¯æ—¢å‡ºãªã®ã§çœç•¥

   // ç›£è¦–å¯¾è±¡ã®å€¤ã‚’å†…éƒ¨ã§ç®¡ç†ã™ã‚‹Uncontrolledãƒ‘ã‚¿ãƒ¼ãƒ³
   //ï¼ˆControlledã¨ã®å·®åˆ†ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«diffã§è¡¨ç¤ºï¼‰
   const UncontrolledObserverProvider: FC<UncontrolledObserverProviderProps<T>> = ({ initialValue, children }) => {
     // depså¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹ãŸã‚ã«refã«é€€é¿ã™ã‚‹
     const observedValueRef = useRef(initialValue);
-    const observedValueRef = useRef(value);
-    observedValueRef.current = value;
-    const onChangeValueRef = useRef(onChangeValue);
-    onChangeValueRef.current = onChangeValue;
    
     const getObservedValue: ObserverContextValue<T>['getObservedValue'] =
     useCallback(() => {
       return observedValueRef.current;
     }, []);
    
     const { addListener, removeListener, broadcast } =
       useObserverListeners<T>();
     const updateObservedValue: ObserverContextValue<T>['updateObservedValue'] =
       useCallback((updater) => {
         const newValue = checkIsUpdaterFn(updater)
           ? updater(observedValueRef.current)
           : updater;

-        onChangeValueRef.current(newValue);
+        // ã“ã®æ™‚ç‚¹ã§å€¤ã‚’æ›´æ–°ã—ã¦ãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥ã™ã‚‹
+        observedValueRef.current = newValue;
+        broadcast(newValue)
       }, [broadcast]);

     const contextValue = useMemo<ObserverContextValue<T>>(() => {
       return {
         getObservedValue,
         updateObservedValue,
         addListener,
         removeListener,
       };
     }, [getObservedValue, updateObservedValue, addListener, removeListener]);
 
     return (
       <ObserverContext.Provider value={contextValue}>
         {children}
       </ObserverContext.Provider>
     );
   }

+  // propsã®ä¸­èº«ã‚’è¦‹ã¦Controlledã‹Uncontrolledã‹ã‚’å‘¼ã³å‡ºã™
+  const ObserverProvider: FC<ObserverProviderProps<T>> = (props) => {
+    return 'value' in props ? <ControlledObserverProvider {...props} /> : <UncontrolledObserverProvider {...props} />
+  };

   return ObserverProvider;
 };
```

Uncontrolledãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã§ãã¾ã—ãŸãŒã€å€¤ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯`useObserverContextValue`ã‹ã‚‰`updateObservedValue`ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€Providerã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸä¸­ã§ã—ã‹ä½¿ãˆãš`~Inner`ã¿ãŸã„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç”¨æ„ã—ã¦ä½™è¨ˆãªå†…éƒ¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«`withUncontrolledObserverProvider`ã¨ã„ã†HOCã‚’`createObserverContextKit`ã«å«ã‚ã¾ã™ã€‚

```diff tsx:withUncontrolledObserverProviderã‚’è¿½åŠ 
 export const createObserverContextKit = function <T>({
   notProvidedErrorMessage = 'ObserverProviderãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
 }: {
   notProvidedErrorMessage?: string;
 } = {}) {
   const ObserverContext = createContext<ObserverContextValue<T> | undefined>(
     undefined
   );
   const ObserverProvider = createObserverProvider(ObserverContext);

+  /**
+   * ç›£è¦–ã™ã‚‹å€¤ã‚’å†…éƒ¨ã§ç®¡ç†ã™ã‚‹Providerã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹
+   */
+  const withUncontrolledObserverProvider = function <P extends object>(
+    Component: ComponentType<P>,
+    {
+      initialValue: initialValueCreater,
+    }: {
+      initialValue: (props: P) => T;
+    }
+  ) {
+    const WrappedComponent: FC<P> = (props) => {
+      const [initialValue] = useState(() => {
+        return initialValueCreater(props);
+      });
+
+      return (
+        <ObserverProvider initialValue={initialValue}>
+          <Component {...props} />
+        </ObserverProvider>
+      );
+    };
+
+    return WrappedComponent;
+  };

   // ä¸€éƒ¨çœç•¥

   return {
     ObserverProvider,
     withUncontrolledObserverProvider,
     useObserverContextValue,
     useObserve,
   };
 };
```

ã“ã‚Œã‚’ç”¨æ„ã—ã¦ãŠãã“ã¨ã§Providerã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹æ™‚ç‚¹ã§ObserverContextValueã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```tsx:withUncontrolledObserverProviderã‚’ä½¿ã£ã¦Providerã‚’å®šç¾©ã™ã‚‹ä¾‹
export const MyUncontrolledProvider = withUncontrolledObserverProvider(
  ({ children }: PropsWithChildren<{ initialValue: any }>) => {
    // withUncontrolledObserverProviderã§ãƒ©ãƒƒãƒ—ã—ã¦ã„ã‚‹ãŸã‚ã€
    // ã“ã“ã§ObserverContextValueã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
    const { updateObservedValue } = useObserverContextValue();

    // updateObservedValueã‚’ä½¿ã£ã¦æ›´æ–°ã§ãã‚‹

    return children;
  },
  {
    // propsã®å€¤ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹
    initialValue: ({ initialValue }) => initialValue,
  }
);
```

### ä½¿ç”¨ä¾‹: windowå¹…ã®ç®¡ç†

ã“ã¡ã‚‰ã®Uncontrolledã‚’ä½¿ã£ãŸä¾‹ã¨ã—ã¦ã€windowå¹…ã‚’ç®¡ç†ã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

```tsx:createObserverContextKitã‚’ä½¿ã£ã¦Uncontrolledãªwindowå¹…ã®ç®¡ç†Providerã‚’å®Ÿè£…ã™ã‚‹
import type { PropsWithChildren } from 'react';
import { useEffect, useCallback } from 'react';

import { createObserverContextKit } from './createObserverContextKit';

const {
  withUncontrolledObserverProvider,
  useObserverContextValue,
  useObserve,
} = createObserverContextKit<number>({
  notProvidedErrorMessage: 'WindowWidthProviderãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
});

export type WindowWidthProviderProps = PropsWithChildren;

/**
 * windowã®å¹…ã‚’ç®¡ç†ã™ã‚‹Provider
 */
export const WindowWidthProvider = withUncontrolledObserverProvider(
  ({ children }: WindowWidthProviderProps) => {
    const { updateObservedValue } = useObserverContextValue();

    useEffect(() => {
      const handleResize = () => {
        updateObservedValue(window.innerWidth);
      };
      window.addEventListener('resize', handleResize);

      return () => {
        window.removeEventListener('resize', handleResize);
      };
    }, [updateObservedValue]);

    return children;
  },
  {
    initialValue: () => window.innerWidth,
  }
);

/**
 * windowã®å¹…ã‚’å–å¾—
 */
export const useWindowWidth = () => {
  const callback = useCallback((width: number) => width, []);
  return useObserve(callback);
};

/**
 * é–¾å€¤ä»¥ä¸Šã®å¹…ãŒã‚ã‚‹ã‹
 * @param threshold - é–¾å€¤
 */
export const useIsLargerWidth = (threshold: number) => {
  const callback = useCallback(
    (width: number) => width >= threshold,
    [threshold]
  );
  return useObserve(callback);
};
```

`useWindowWidth`ã¯æ¯å›å€¤ãŒå¤‰ã‚ã‚‹ã®ã§rerenderã—ã¦ã—ã¾ã„ã¾ã™ãŒã€`useIsLargerWidth`ã¯thresholdã‚’è¶…ãˆãŸã‹å¦ã‹ã®æ™‚ã ã‘å¤‰ã‚ã‚‹ã®ã§ãã®æ™‚ã ã‘rerenderã•ã‚Œã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](/images/common-observer-provider/rerender-larger-width.gif)

:::message
`useObserve`ã®æ³¨æ„ç‚¹ã§å¼•æ•°ã§ã‚ã‚‹callbackã¯ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ãªã„ã¨ä½•åº¦ã‚‚å†è¨ˆç®—ãŒè¡Œã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚å†è¨ˆç®—ã—ã¦ã‚‚åŒã˜å€¤ã§ã‚ã‚Œã°rerenderã®å¯¾è±¡ã«ãªã‚‰ãªã„ã®ã§å¤§ããªå•é¡Œã«ã¯ãªã‚Šã¾ã›ã‚“ãŒã€ã‚ˆã‚Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ„è­˜ã™ã‚‹å ´åˆã¯ä¸Šã®ä¾‹ã®ã‚ˆã†ã«`useCallback`ã§ãƒ¡ãƒ¢åŒ–ã—ã¦ãŠãã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚
:::

## çµ‚ã‚ã‚Šã«

ä»¥ä¸ŠãŒRerenderã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹æ±ç”¨çš„ãªå€¤ç›£è¦–Providerã®å®Ÿè£…æ–¹æ³•ã§ã—ãŸã€‚æ±ç”¨çš„ãªProviderã‚’ä½œã£ãŸã“ã¨ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ã«subscribeå½¢å¼ã«å¤‰ãˆã‚‹ã®ãŒéå¸¸ã«ã‚„ã‚Šã‚„ã™ããªã‚Šã¾ã—ãŸã€‚rerenderã‚’æŠ‘åˆ¶ã—ãŸã„æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
æœ€å¾Œã«æ¤œè¨¼ã§ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«è²¼ã£ã¦ãŠãã¾ã™ã®ã§ã€è©³ç´°æ°—ã«ãªã‚‹æ–¹ã¯ã“ã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

@[stackblitz](https://stackblitz.com/edit/vitejs-vite-y7dyjkzu?ctl=1&embed=1&file=src%2Fproviders%2FcreateObserverContextKit%2FcreateObserverContextKit.tsx&view=preview)
