---
title: "callbackãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚‹rerenderã‚’é˜²ãhooksã‚’ä½œæˆ"
emoji: "ğŸ“Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react"]
published: true
---

# å§‹ã‚ã«
Reactã§ã¯rerenderã®æ¡ä»¶ãŒã‚·ãƒ“ã‚¢ã§ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚renderã®åº¦ã«ä½œã‚Šç›´ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å¤‰æ›´æ¤œçŸ¥ã®å¯¾è±¡ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚`useCallback`ã‚’ä½¿ã†ã“ã¨ã§ãƒ¡ãƒ¢åŒ–ã—ã¦å†ç”Ÿæˆã‚’æŠ‘åˆ¶ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ã€‚

```tsx:renderã®åº¦ã«ä½œã‚Šç›´ã•ã‚Œã‚‹
const Comp = () => {
  return (
    <button
      // ç„¡åé–¢æ•°ã‚’ç›´æ¥ç”Ÿæˆã—ã¦ä»£å…¥ã—ã¦ã„ã‚‹ãŸã‚ã€renderã®åº¦ã«æ–°ã—ã„é–¢æ•°ã‚’æ¸¡ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹
      onClick={() => {
        console.log('clicked');
      }}
    >
      ãƒœã‚¿ãƒ³
    </button>
  )
}
```

```tsx:ãƒ¡ãƒ¢åŒ–ã§å†ç”Ÿæˆã‚’æŠ‘åˆ¶ã™ã‚‹
const Comp = () => {
  // useCallbackã§ãƒ¡ãƒ¢åŒ–ã™ã‚‹
  const handleClick = useCallback(() => {
    console.log('clicked');
  }, []);

  return (
    <button
      // ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ã‚‹ãŸã‚ã€ä½•å›renderã—ã¦ã‚‚åŒã˜ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¸¡ã—ã¦ãã‚Œã‚‹
      onClick={handleClick}
    >
      ãƒœã‚¿ãƒ³
    </button>
  )
}
```

ãƒ¡ãƒ¢åŒ–ã™ã‚Œã°ç¢ºã‹ã«å†ç”Ÿæˆã‚’æŠ‘åˆ¶ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€å…¨ã¦ã®å ´æ‰€ã§ãã‚Œã‚’è¡Œã‚ãªã„ã¨depsã§å¤‰æ›´å¯¾è±¡ã«ãªã£ã¦ã—ã¾ã„ã€æŠ˜è§’ã®ãƒ¡ãƒ¢åŒ–ã‚‚ç„¡é§„ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```tsx
export type MemoCounterProps = {
  count: number;
  onChangeCount: (newCount: number) => void;
};

export const MemoCounter: FC<MemoCounterProps> = ({ count, onChangeCount }) => {
  const handlePlusButtonClick = useCallback(() => {
    onChangeCount(count + 1);
  }, [count, onChangeCount]);

  const handleMinusButtonClick = useCallback(() => {
    onChangeCount(count - 1);
  }, [count, onChangeCount]);

  return (
    <div style={{ display: "flex" }}>
      <button onClick={handleMinusButtonClick}>-</button>
      <div style={{ padding: "0 4px" }}>{count}</div>
      <button onClick={handlePlusButtonClick}>
        +
      </button>
    </div>
  );
};

const App: FC = () => {
  const [count, setCount] = useState(0);

  return (
    <MemoCounter
      count={count}
      // æŠ˜è§’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ãŒmemoåŒ–ã‚’æ„è­˜ã—ã¦ã‚‚ã€ä½¿ã†å´ã§ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ãªã‹ã£ãŸã‚‰çµå±€ä½œã‚Šç›´ã•ã‚Œã‚‹
      onChangeCount={(newCount) => {
        setCount(newCount);
      }}
    />
  );
}
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯å®Ÿã¯ä»–ã«ã‚‚å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚**countãŒå¤‰æ›´ã™ã‚‹ã¨ãã‚‚ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œã‚Šç›´ã•ã‚Œã¦ã—ã¾ã†ã“ã¨ã§ã™ã€‚** ã“ã‚Œã¯Reactã®ä»•æ§˜ä¸Šã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã“ã¨ã§ã™ãŒã€depsã®å¯¾è±¡ã«å«ã¾ã‚Œã‚‹ã“ã¨ã§é€†ã«ä¸å…·åˆã‚’èµ·ã“ã™ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šã€æœ€æ‚ª `eslint-disable-next-line react-hooks/exhaustive-deps` ã§ç„¡è¦–ã™ã‚‹ã—ã‹ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚ãŸã ã“ã‚Œã¯æœ¬å½“ã®æœ€çµ‚æ‰‹æ®µã§ã‚ã‚Šã€å¯èƒ½ãªé™ã‚Šä½¿ã‚ãšã«æ¸ˆã¾ã›ãŸã„ã§ã™ã€‚

:::message
ã€ŒcountãŒå¤‰æ›´ã™ã‚‹ã¨ãã‚‚ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œã‚Šç›´ã•ã‚Œã¦ã—ã¾ã†ã€å•é¡Œã¯ã€è¨­è¨ˆæ¬¡ç¬¬ã§ã¯å›é¿ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãŸã ä»Šå›ã¯å•é¡ŒãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã‚ãˆã¦ä¸Šè¨˜ã®ã‚ˆã†ãªä½œã‚Šã‚’ã—ã¦ã„ã¾ã™ã€‚

ã‚‚ã—è¨­è¨ˆã§å›é¿ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå¯¾å¿œãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

:::details seté–¢æ•°ã§ç¾åœ¨ã®å€¤ã‚’å–å¾—ã—ã¦countã‚’depså¯¾è±¡ã‹ã‚‰å¤–ã™

seté–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é–¢æ•°ã‚’çµŒç”±ã™ã‚‹ã“ã¨ã§ç¾åœ¨ã®å€¤ã‚’å–å¾—ã—ã¦æ¬¡ã®å€¤ã‚’ç®—å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
setCount((prevCount) => prevCount + 1);
```

ã“ã®ä»•æ§˜ã‚’æ´»ã‹ã™ã“ã¨ã§`count`ã‚’depså¯¾è±¡ã‹ã‚‰å¤–ã™ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€propsã«seté–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§`count`ãŒå¤‰æ›´ã™ã‚‹ã¨ãã«ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œã‚Šç›´ã•ã‚Œã‚‹å•é¡Œã¯å›é¿ã§ãã¾ã™ã€‚

```diff tsx:seté–¢æ•°ã§ç¾åœ¨ã®å€¤ã‚’å–å¾—ã—ã¦countã‚’depså¯¾è±¡ã‹ã‚‰å¤–ã™
 import { Dispatch, SetStateAction } from 'react';

 export type MemoCounterProps = {
   count: number;
-  onChangeCount: (newCount: number) => void;
+  onChangeCount: Dispatch<SetStateAction<number>>;
 };

 export const MemoCounter: FC<MemoCounterProps> = ({ count, onChangeCount }) => {
   const handlePlusButtonClick = useCallback(() => {
+    onChangeCount((prevCount) => prevCount + 1);
-    onChangeCount(count + 1);
-  }, [count, onChangeCount]);
+  }, [onChangeCount]);

   const handleMinusButtonClick = useCallback(() => {
+    onChangeCount((prevCount) => prevCount - 1);
-    onChangeCount(count - 1);
-  }, [count, onChangeCount]);
+  }, [onChangeCount]);

   return (
     <div style={{ display: "flex" }}>
       <button onClick={handleMinusButtonClick}>-</button>
       <div style={{ padding: "0 4px" }}>{count}</div>
       <button onClick={handlePlusButtonClick}>
         +
       </button>
     </div>
   );
 };

 const App: FC = () => {
   const [count, setCount] = useState(0);

   return (
     <MemoCounter
       count={count}
-     // æŠ˜è§’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ãŒmemoåŒ–ã‚’æ„è­˜ã—ã¦ã‚‚ã€ä½¿ã†å´ã§ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ãªã‹ã£ãŸã‚‰çµå±€ä½œã‚Šç›´ã•ã‚Œã‚‹
-      onChangeCount={(newCount) => {
-        setCount(newCount);
-      }}
+      onChangeCount={setCount}
     />
   );
 }
```

---

ã‚‚ã—seté–¢æ•°ã‚’ç›´æ¥æ¸¡ã™ã®ãŒæ°—ã«ãªã‚‹å ´åˆã¯ã€ãã‚‚ãã‚‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§+1ã‚„-1ã—ãŸã‚Šã™ã‚‹ã®ã‚’ã‚„ã‚ã¦ã€å˜ç´”ã«ãã‚Œãã‚Œã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã€è¨ˆç®—ã¯è¦ªã®æ–¹ã§ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```tsx:minus,plusã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¦ªã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•
export type CounterProps = {
  count: number;
  onPlusButtonClick: () => void;
  onMinusButtonClick: () => void;
};

export const Counter: FC<CounterProps> = ({ count, onPlusButtonClick, onMinusButtonClick }) => {
  return (
    <div style={{ display: "flex" }}>
      <button onClick={onMinusButtonClick}>-</button>
      <div style={{ padding: "0 4px" }}>{count}</div>
      <button onClick={onPlusButtonClick}>+</button>
    </div>
  );
};

const App: FC = () => {
  const [count, setCount] = useState(0);

  const handlePlusButtonClick = useCallback(() => {
    setCount((prevCount) => prevCount + 1);
  }, []);

  const handleMinusButtonClick = useCallback(() => {
    setCount((prevCount) => prevCount - 1);
  }, []);

  return (
    <Counter
      count={count}
      onPlusButtonClick={handlePlusButtonClick}
      onMinusButtonClick={handleMinusButtonClick}
    />
  )
}
```
:::

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã¹ãå…¬å¼ã§ã‚‚`useEffectEvent`ã¨ã„ã†hooksã‚’ç­–å®šä¸­ã§ã™ãŒã€ç¾çŠ¶ã§ã¯ã¾ã ä½¿ãˆã¾ã›ã‚“ã€‚

https://ja.react.dev/learn/separating-events-from-effects#declaring-an-effect-event

ç¾çŠ¶ã®ä»•æ§˜ã§ã‚‚ä½•ã¨ã‹ã“ã®å•é¡Œã‚’è§£æ±ºã§ããªã„ã‹è‰²ã€…è€ƒãˆã¦ã„ã¾ã—ãŸãŒã€refã§ä¸€åº¦ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ãŠã‘ã°ä¸Šæ‰‹ãã„ãã®ã§ã¯ï¼Ÿã¨æ€ã£ãŸã®ã§ãã®è¾ºã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

# callbackã‚’refã§æŒã£ã¦depså¯¾è±¡ã‹ã‚‰å¤–ã™

depsã®å¯¾è±¡ã«ãªã‚‹ã®ã¯ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚ã‚‹stateã‚„propsã§ã€refã¯å¯¾è±¡å¤–ã«ãªã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦renderã®ãŸã³ä¸€åº¦refã«é€€é¿ã—ã¦ã€ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œæ™‚ã«é€€é¿ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§depså¯¾è±¡ã‹ã‚‰å¤–ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff tsx:refã«ä¸€æ™‚é€€é¿ã—ã¦depså¯¾è±¡ã‹ã‚‰å¤–ã™
 export const MemoCounter: FC<MemoCounterProps> = ({ count, onChangeCount }) => {
+  const onChangeCountRef = useRef(onChangeCount);
+  onChangeCountRef.current = onChangeCount;

   const handlePlusButtonClick = useCallback(() => {
+    onChangeCountRef.current(count + 1);
-    onChangeCount(count + 1);
-  }, [count, onChangeCount]);
+  }, [count]);

   const handleMinusButtonClick = useCallback(() => {
+    onChangeCountRef.current(count - 1);
-    onChangeCount(count - 1);
-  }, [count, onChangeCount]);
+  }, [count]);

   return (
     <div style={{ display: "flex" }}>
       <button onClick={handleMinusButtonClick}>-</button>
       <div style={{ padding: "0 4px" }}>{count}</div>
       <button isShowUpdateCallbackCount onClick={handlePlusButtonClick}>
         +
       </button>
     </div>
   );
 };
```

ã“ã‚Œã«ã‚ˆã£ã¦ `onChangeCount` ãƒ¡ã‚½ãƒƒãƒ‰ãŒrenderã™ã‚‹ãŸã³ã«æ–°ã—ããªã£ã¦ã„ã¦ã‚‚ `handle~` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å†ç”Ÿæˆã•ã‚Œãšã«æ¸ˆã¿ã¾ã™ã€‚
åŒã˜è¦é ˜ã§countã‚‚refã«é€€é¿ã™ã‚‹ã“ã¨ã§depsã‹ã‚‰å¤–ã›ã¾ã™ãŒã€ä¸€ã€…refã«é€€é¿ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã®ã¯æ‰‹é–“ãªã®ã§ã€ãã®è¾ºã‚’ã‚„ã£ã¦ãã‚Œã‚‹hooksã‚’ä½œã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚

# callbackã‚’refã«é€€é¿ã—ã¦depsã‚’ç„¡è¦–ã—ã¦ãƒ¡ãƒ¢åŒ–ã§ãã‚‹hooks
hooksã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚callbackã‚’refã«é€€é¿ã•ã›ã‚‹ãŸã‚ã€çµæœçš„ã«å…¨ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’depsã®å¯¾è±¡ã‹ã‚‰é™¤å¤–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

```ts:callbackã‚’refã«é€€é¿ã—ã¦depsã‚’ç„¡è¦–ã—ã¦ãƒ¡ãƒ¢åŒ–ã§ãã‚‹hooks
import { useRef, useCallback } from "react";

/**
 * depsã‚’ç„¡è¦–ã—ã¦æœ€æ–°ã®stateã‚’å‚ç…§ã§ãã‚‹ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿”ã™hooks
 * @param callback - ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
 */
export const useMemoCallbackWithoutDeps = <
  Callback extends (...args: any) => any
>(
  callback: Callback
): Callback => {
  // refã§ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã“ã¨ã§depså¯¾è±¡ã‹ã‚‰å¤–ã™
  const callbackRef = useRef(callback);

  // renderã®ãŸã³ã«æœ€æ–°ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«æ›´æ–°ã—ã¦ãŠã
  callbackRef.current = callback;

  // å®Ÿéš›ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¯useCallbackã§å¤‰æ›´ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
  const memorizedCallback = useCallback((...args: any[]) => {
    return callbackRef.current(...args);
  }, []);

  // ä¸Šæ‰‹ãå‹ã‚’åˆã‚ã›ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹
  return memorizedCallback as Callback;
};
```

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ `useCallback` ã¨ã»ã¼åŒã˜ã§ã€ç¬¬äºŒå¼•æ•°ã®depsã‚’æ¸¡ã™å¿…è¦ã«ãªããªã£ãŸã ã‘ã«ãªã‚Šã¾ã™ã€‚

```diff tsx:è‡ªä½œhooksã«å·®ã—æ›¿ãˆã‚‹
 export const MemoCounter: FC<MemoCounterProps> = ({ count, onChangeCount }) => {
+  const handlePlusButtonClick = useMemoCallbackWithoutDeps(() => {
-  const handlePlusButtonClick = useCallback(() => {
     onChangeCount(count + 1);
-  }, [count, onChangeCount]);
+  });

+  const handleMinusButtonClick = useMemoCallbackWithoutDeps(() => {
-  const handleMinusButtonClick = useCallback(() => {
     onChangeCount(count - 1);
-  }, [count, onChangeCount]);
+  });

   return (
     <div style={{ display: "flex" }}>
       <button onClick={handleMinusButtonClick}>-</button>
       <div style={{ padding: "0 4px" }}>{count}</div>
       <button isShowUpdateCallbackCount onClick={handlePlusButtonClick}>
         +
       </button>
     </div>
   );
 };
```

# å‹•ä½œç¢ºèª
ä»Šå›ä½œæˆã—ãŸhooksã®å‹•ä½œç¢ºèªã¨ã—ã¦CodeSandboxã§æ¤œè¨¼ã—ã¾ã—ãŸã®ã§ã€ã“ã¡ã‚‰ã«è²¼ã£ã¦ãŠãã¾ã™ã€‚å‘¼ã³å‡ºã—å´ãŒãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ã„ãªãã¦ã‚‚å¤‰æ›´ã•ã‚Œãªã„ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

@[codesandbox](https://codesandbox.io/embed/callbackmesotudoniyorurerenderwofang-guhookswozuo-cheng-5m57ft?fontsize=14&hidenavigation=1&theme=dark)

# çµ‚ã‚ã‚Šã«
ä»¥ä¸ŠãŒcallbackãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚‹rerenderã‚’é˜²ãhooksã®ç´¹ä»‹ã§ã—ãŸã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã«ãŠã„ã¦ã¯ãƒ¡ãƒ¢åŒ–ãŒå¤§äº‹ã«ãªã£ã¦ãã¾ã™ãŒã€ã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã‚±ãƒ¼ã‚¹ãŒå¤šã€…ã‚ã£ãŸã‚Šã€å‘¼ã³å‡ºã—æ™‚ã«ãƒ¡ãƒ¢åŒ–ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¸¡ã•ãªã„ã¨ã„ã‘ãªã„ãªã©é¢å€’ãªãƒ«ãƒ¼ãƒ«ãŒå‡ºæ¥ã¦ã—ã¾ã£ãŸã‚Šã§é ­ã‚’æŠ±ãˆã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã®hooksã«ã‚ˆã£ã¦ã“ã†ã„ã£ãŸå•é¡Œã‹ã‚‰è§£æ”¾ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã—ãŸã€‚
ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¡ãƒ¢åŒ–ã«è‹¦åŠ´ã•ã‚Œã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã‚Œã°å¹¸ã„ã§ã™ã€‚
