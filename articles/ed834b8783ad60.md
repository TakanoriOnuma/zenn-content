---
title: "useMemoã‚’æ‹¡å¼µã—ã¦Object.isä»¥å¤–ã§ãƒ¡ãƒ¢åŒ–æ¡ä»¶ã‚’è¨­å®šã§ãã‚‹hooksã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "usememo"]
published: true
---

## å§‹ã‚ã«

ä»¥å‰ä»¥ä¸‹ã®è¨˜äº‹ã§æ¡ä»¶ã«ã‚ˆã£ã¦ãƒ¡ãƒ¢åŒ–ã™ã‚‹hooksã‚’ä½œã‚Šã¾ã—ãŸã€‚

https://zenn.dev/numa_san/articles/5dec13c6b4d0a8

```ts:æ¡ä»¶ã«ã‚ˆã£ã¦ãƒ¡ãƒ¢åŒ–ã™ã‚‹hooks
import { useRef } from 'react';

/**
 * æ¡ä»¶ãŒtrueã®æ™‚ã ã‘ãƒ¡ãƒ¢åŒ–ã™ã‚‹hooks
 * @param value - ãƒ¡ãƒ¢åŒ–å¯¾è±¡ã®value
 * @param isSameHandler - åŒã˜å€¤ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ã€‚trueã®æ™‚ã«ãƒ¡ãƒ¢åŒ–ã•ã‚Œã‚‹
 */
export const useConditionalMemo = <T>(
  value: T,
  isSameHandler: (current: T, next: T) => boolean
): T => {
  /** åˆå›renderã‹ */
  const isFirstRef = useRef(true);
  const currentValueRef = useRef<T>(value);

  // åˆå›renderã®æ™‚ã¯æ¯”è¼ƒã™ã‚‹å¿…è¦ãŒãªã„ã®ã§ç¾åœ¨ã®å€¤ã‚’è¿”ã™
  if (isFirstRef.current) {
    isFirstRef.current = false;
    return currentValueRef.current;
  }

  // ç¾åœ¨ã®å€¤ã¨æ¬¡ã®å€¤ã‚’æ¯”è¼ƒã—ã€ç•°ãªã‚‹å€¤ã¨åˆ¤å®šã•ã‚ŒãŸã‚‰æ›´æ–°ã™ã‚‹
  if (!isSameHandler(currentValueRef.current, value)) {
    currentValueRef.current = value;
  }

  return currentValueRef.current;
};
```

ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã‚’ç›®æŒ‡ã—ãŸã“ã¨ã§ä¸Šã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸãŒã€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ¸¡ã›ãšå¯¾è±¡ã®å€¤ã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã‹ã ã‘ã§ã‚ã‚‹ãŸã‚ã€ã“ã®hooksã§ä¸€åº¦ãƒ¡ãƒ¢åŒ–ã—ã¦ã‹ã‚‰æ›´ã«`useMemo`ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹ã®ãŒé¢å€’ã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚

```ts:ä¸€åº¦æ¡ä»¶ä»˜ããƒ¡ãƒ¢åŒ–ã‚’ã—ã¦ã‹ã‚‰useMemoã®depsã«æ¸¡ã™æ‰‹é–“
// åŒã˜æ—¥ã®æ™‚ã€ãƒ¡ãƒ¢åŒ–ã™ã‚‹
const memorizedBirthDate = useConditionalMemo(birthDate, (current, next) => {
  return isSameDay(current, next);
})
const age = useMemo(() => {
  numCalcAgeRef.current += 1;
  return differenceInYears(new Date(), memorizedBirthDate);
  // ãƒ¡ãƒ¢åŒ–ã—ãŸæ—¥ä»˜ã‚’depsã«å…¥ã‚Œã‚‹
}, [memorizedBirthDate]);
```

ã“ã†ã„ã†æ›¸ãæ–¹ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã‚ã‚Œã°ã€`useMemo`ã‚’æ‹¡å¼µã—ã¦ç¬¬3å¼•æ•°ã«`Object.is`ä»¥å¤–ã§æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸæ–¹ãŒä½¿ã„å‹æ‰‹è‰¯ã„ã®ã‹ãªï¼Ÿã¨æ€ã„ã€ãã®å®Ÿè£…ã‚‚è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

```ts:useMemoã‚’æ‹¡å¼µã—ã¦ãƒ¡ãƒ¢åŒ–æ¡ä»¶ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
const age = useMemoEx(
  () => {
    numCalcAgeRef.current += 1;
    return differenceInYears(new Date(), birthDate);
  },
  [birthDate],
  // depsã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒã—ã¦ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã‹åˆ¤å®šã™ã‚‹
  ([currentBirthDate], [nextBirthDate]) => {
    return isSameDay(currentBirthDate, nextBirthDate)
  }
);
```

## useMemoã‚’æ‹¡å¼µã—ã¦Object.isä»¥å¤–ã§ãƒ¡ãƒ¢åŒ–æ¡ä»¶ã‚’è¨­å®šã™ã‚‹hooksã‚’ä½œæˆ

ä¸Šã®å‘¼ã³å‡ºã—ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…ƒã«ã€ä»Šå›å®Ÿè£…ã—ãŸhooksã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚`factory`ã®å®Ÿè¡Œçµæœã‚’ä¿å­˜ã™ã‚‹éš›ã«ã€rerenderã®åº¦ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨æœ¬æœ«è»¢å€’ãªã®ã§`useState`ã®åˆæœŸè¨­å®šã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã«ã™ã‚‹ã“ã¨ã§æœ€åˆã®ä¸€å›ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```ts
import { useState, useRef } from "react";

type AcceptDepsPattern =
  | Readonly<[]>
  | Readonly<[any]>
  | Readonly<[any, any]>
  | Readonly<[any, any, any]>
  | Readonly<[any, any, any, any]>
  | Readonly<[any, any, any, any, any]>
  | Readonly<any[]>;

// defaultIsMemoHandlerã¯æ¬¡ã§è¨˜è¼‰

/**
 * useMemoã«ãƒ¡ãƒ¢åŒ–æ¡ä»¶ã§Object.isä»¥å¤–ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã—ãŸhooks
 * @param factory - ãƒ¡ãƒ¢åŒ–å¯¾è±¡ã®å€¤ã‚’ç”Ÿæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
 * @param deps - ä¾å­˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 * @param isMemo - ä¾å­˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒã—ã¦ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã‹ã€‚trueã®å ´åˆã¯æ›´æ–°ã—ãªã„
 */
export const useMemoEx = <T, Deps extends AcceptDepsPattern>(
  factory: () => T,
  deps: Deps,
  isMemo: (current: Deps, next: Deps) => boolean = defaultIsMemoHandler
): T => {
  /** åˆå›renderã‹ */
  const isFirstRef = useRef(true);
  // æœ€åˆã«å®Ÿè¡Œã—ãŸéš›ã®å€¤ã‚’æŒã¤
  const [firstValue] = useState(() => {
    return factory();
  });

  const currentValueRef = useRef<T>(firstValue);
  const currentDeps = useRef<Deps>(deps);

  // åˆå›renderã®æ™‚ã¯æ¯”è¼ƒã™ã‚‹å¿…è¦ãŒãªã„ã®ã§ç¾åœ¨ã®å€¤ã‚’è¿”ã™
  if (isFirstRef.current) {
    isFirstRef.current = false;
    return currentValueRef.current;
  }

  // ãƒ¡ãƒ¢åŒ–ã—ãŸã„å ´åˆã®ã¿å€¤ã‚’æ›´æ–°ã™ã‚‹
  if (!isMemo(currentDeps.current, deps)) {
    currentValueRef.current = factory();
  }

  currentDeps.current = deps;
  return currentValueRef.current;
};
```

ãªãŠã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ã«å…¥ã‚Œã¦ã„ã‚‹`defaultIsMemoHandler`ã¯ä»¥ä¸‹ã§ã€ã“ã‚ŒãŒ`useMemo`æ¨™æº–ã®`Object.is`ã§æ¯”è¼ƒã™ã‚‹ãƒ¡ãƒ¢åŒ–æ¡ä»¶ã¨åŒç­‰ãªã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

```ts:defaultIsMemoHandler
/**
 * Object.isã§ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©
 * @param current - ç¾åœ¨ã®deps
 * @param next - æ¬¡ã®deps
 */
const defaultIsMemoHandler = (
  current: Readonly<any[]>,
  next: Readonly<any[]>
): boolean => {
  if (current.length !== next.length) {
    throw new Error("depsã®æ•°ã‚’å¤‰ãˆã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“");
  }

  for (let i = 0; i < current.length; i++) {
    if (!Object.is(current[i], next[i])) {
      return false;
    }
  }

  return true;
};
```

### ESLintã®è¨­å®š

æœ€å¾Œã«`factory`å†…ã§ä½¿ç”¨ã—ã¦ã„ã‚‹å¤‰æ•°ãŒ`deps`ã«ã‚­ãƒãƒ³ã¨å«ã¾ã‚Œã‚‹ã‚ˆã†ã«`react-hooks/exhaustive-deps`ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ `additionalHooks` ã§hooksåã‚’æŒ‡å®šã™ã‚‹ã¨ã‚«ã‚¹ã‚¿ãƒ hookã§ã‚‚è¦‹ã¦ãã‚Œã‚‹ã‚ˆã†ãªã®ã§ãã‚Œã‚‚è¨­å®šã—ã¾ã™ã€‚

https://github.com/facebook/react/blob/main/packages/eslint-plugin-react-hooks/README.md#advanced-configuration

```diff ts:eslint.config.js
 import js from '@eslint/js';
 import globals from 'globals';
 import reactHooks from 'eslint-plugin-react-hooks';
 import reactRefresh from 'eslint-plugin-react-refresh';
 import tseslint from 'typescript-eslint';

 export default tseslint.config({
   extends: [js.configs.recommended, ...tseslint.configs.recommended],
   files: ['**/*.{ts,tsx}'],
   ignores: ['dist'],
   languageOptions: {
     ecmaVersion: 2020,
     globals: globals.browser,
   },
   plugins: {
     'react-hooks': reactHooks,
     'react-refresh': reactRefresh,
   },
   rules: {
     ...reactHooks.configs.recommended.rules,
     'react-refresh/only-export-components': [
       'warn',
       { allowConstantExport: true },
     ],
+    'react-hooks/exhaustive-deps': [
+      'error',
+      {
+        additionalHooks: 'useMemoEx',
+      },
+    ],
   },
 });
```

StackBlitzã ã¨ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ESLintã‚¨ãƒ©ãƒ¼ã¯å‡ºã¦ãã¾ã›ã‚“ãŒã€`npm run lint`ã™ã‚‹ã“ã¨ã§ã‚­ãƒãƒ³ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ãã‚Œã¾ã—ãŸğŸ˜Š

![](/images/use-memo-ex/eslint-error.png)

## çµ‚ã‚ã‚Šã«

ä»¥ä¸ŠãŒuseMemoã‚’æ‹¡å¼µã—ã¦Object.isä»¥å¤–ã§ãƒ¡ãƒ¢åŒ–æ¡ä»¶ã‚’è¨­å®šã™ã‚‹hooksã®å®Ÿè£…ã§ã—ãŸã€‚æœ€åˆã¯ã‹ãªã‚Šå®Ÿè£…ãŒè¤‡é›‘ã«ãªã‚‹ã‹ãªã¨æ€ã„ã‚·ãƒ³ãƒ—ãƒ«ãªä»•æ§˜ã§å¯¾å¿œã—ã¾ã—ãŸãŒã€ESLintã®è¨­å®šã‚‚å«ã‚ã¦æ„å¤–ã¨ã‚ã£ã•ã‚Šã¨ã§ãã¦ã—ã¾ã£ãŸã®ã§ã€ã“ã¡ã‚‰ã®æ–¹ãŒä½¿ã„å‹æ‰‹è‰¯ã„ã‹ã‚‚ãªã¨æ€ã„ã¾ã—ãŸğŸ¤” `Object.is`ä»¥å¤–ã®æ¡ä»¶ã§ãƒ¡ãƒ¢åŒ–ã—ãŸããªã£ãŸæ™‚ã®å‚è€ƒã«ãªã‚Œã‚Œã°å¹¸ã„ã§ã™ã€‚

æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®StackBlitzã§è¡Œã„ã¾ã—ãŸã®ã§ã€è©³ç´°ã®ã‚³ãƒ¼ãƒ‰ã‚„å‹•ä½œãŒæ°—ã«ãªã‚‹æ–¹ã¯æ˜¯éã”å‚ç…§ãã ã•ã„ã€‚

@[stackblitz](https://stackblitz.com/edit/vitejs-vite-e6hn2j?embed=1&file=src%2FApp.tsx&view=preview)
